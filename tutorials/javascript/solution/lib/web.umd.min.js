!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):((t=t||self).web=t.web||{},t.web.min=e())}(this,(function(){"use strict";var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(e,n)};var e=function(){return(e=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function n(t,e,n,r){return new(n||(n=Promise))((function(o,i){function s(t){try{c(r.next(t))}catch(t){i(t)}}function a(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){t.done?o(t.value):new n((function(e){e(t.value)})).then(s,a)}c((r=r.apply(t,e||[])).next())}))}function r(t,e){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=e.call(t,s)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}var o=1;var i,s,a,c={nextValue:function(){return(o=(9301*o+49297)%233280)/233280},seed:function(t){o=t}},u="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function d(){a=!1}function p(t){if(t){if(t!==i){if(t.length!==u.length)throw new Error("Custom alphabet for shortid must be "+u.length+" unique characters. You submitted "+t.length+" characters: "+t);var e=t.split("").filter((function(t,e,n){return e!==n.lastIndexOf(t)}));if(e.length)throw new Error("Custom alphabet for shortid must be "+u.length+" unique characters. These characters were not unique: "+e.join(", "));i=t,d()}}else i!==u&&(i=u,d())}function l(){return a||(a=function(){i||p(u);for(var t,e=i.split(""),n=[],r=c.nextValue();e.length>0;)r=c.nextValue(),t=Math.floor(r*e.length),n.push(e.splice(t,1)[0]);return n.join("")}())}var h={get:function(){return i||u},characters:function(t){return p(t),i},seed:function(t){c.seed(t),s!==t&&(d(),s=t)},lookup:function(t){return l()[t]},shuffled:l},f="object"==typeof window&&(window.crypto||window.msCrypto),v=f&&f.getRandomValues?function(t){return f.getRandomValues(new Uint8Array(t))}:function(t){for(var e=[],n=0;n<t;n++)e.push(Math.floor(256*Math.random()));return e},g=function(t,e,n){for(var r=(2<<Math.log(e.length-1)/Math.LN2)-1,o=-~(1.6*r*n/e.length),i="";;)for(var s=t(o),a=o;a--;)if((i+=e[s[a]&r]||"").length===+n)return i};var m,y,b=function(t){for(var e,n=0,r="";!e;)r+=g(v,h.get(),1),e=t<Math.pow(16,n+1),n++;return r};var w=function(t){var e="",n=Math.floor(.001*(Date.now()-1567752802062));return n===y?m++:(m=0,y=n),e+=b(7),e+=b(t),m>0&&(e+=b(m)),e+=b(n)};var S=function(t){return!(!t||"string"!=typeof t||t.length<6)&&!new RegExp("[^"+h.get().replace(/[|\\{}()[\]^$+*?.-]/g,"\\$&")+"]").test(t)},x=function(t,e,n){return t(n={path:e,exports:{},require:function(t,e){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==e&&n.path)}},n.exports),n.exports}((function(t){var e=0;function n(){return w(e)}t.exports=n,t.exports.generate=n,t.exports.seed=function(e){return h.seed(e),t.exports},t.exports.worker=function(n){return e=n,t.exports},t.exports.characters=function(t){return void 0!==t&&h.characters(t),h.shuffled()},t.exports.isValid=S})),_=function(){function t(t,e,n,r){this.id=t,this.name=e,this.control=n,this.windows=r}return t.prototype.getURL=function(){var t;return n(this,void 0,void 0,(function(){var e;return r(this,(function(n){switch(n.label){case 0:return[4,this.callControl("getURL",{})];case 1:return e=n.sent(),[2,null===(t=null==e?void 0:e.returned)||void 0===t?void 0:t._value]}}))}))},t.prototype.moveResize=function(t){return n(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.callControl("moveResize",t,!0)];case 1:return e.sent(),[2,this]}}))}))},t.prototype.close=function(){return n(this,void 0,void 0,(function(){var t=this;return r(this,(function(e){return[2,new Promise((function(e,n){var r=function(){i&&clearTimeout(i),o&&o()},o=t.windows.onWindowRemoved((function(n){n.id===t.id&&(e(t),r())})),i=setTimeout((function(){n("can not close window - probably not opened by your window"),r()}),1e3);t.callControl("close",{},!0).catch((function(){}))}))]}))}))},t.prototype.setTitle=function(t){return n(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return"string"==typeof t&&(t={title:t}),[4,this.callControl("setTitle",t,!0)];case 1:return e.sent(),[2,this]}}))}))},t.prototype.resizeTo=function(t,e){return n(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.callControl("moveResize",{width:t,height:e},!0)];case 1:return n.sent(),[2,this]}}))}))},t.prototype.moveTo=function(t,e){return n(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.callControl("moveResize",{top:t,left:e},!0)];case 1:return n.sent(),[2,this]}}))}))},t.prototype.focus=function(){return n(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,this.callControl("focus",{},!0)];case 1:return t.sent(),[2,this]}}))}))},t.prototype.getBounds=function(){return n(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,this.callControl("getBounds",{})];case 1:return[2,t.sent().returned]}}))}))},t.prototype.getContext=function(){return n(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,this.callControl("getContext",{})];case 1:return[2,t.sent().returned]}}))}))},t.prototype.getTitle=function(){return n(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,this.callControl("getTitle",{})];case 1:return[2,t.sent().returned._value]}}))}))},t.prototype.onContextUpdated=function(t){throw new Error("Method not implemented.")},t.prototype.updateContext=function(t){return n(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.callControl("updateContext",t,!0)];case 1:return e.sent(),[2,this]}}))}))},t.prototype.setContext=function(t){return n(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.callControl("setContext",t,!0)];case 1:return e.sent(),[2,this]}}))}))},t.prototype.callControl=function(t,e,o){return void 0===o&&(o=!1),n(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.control.send({command:t,domain:"windows",args:e,skipResult:o},{windowId:this.id})];case 1:return[2,n.sent()]}}))}))},t}();function k(t){if(t&&t.errorHandling&&"function"!=typeof t.errorHandling&&"log"!==t.errorHandling&&"silent"!==t.errorHandling&&"throw"!==t.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof t.errorHandling+" was passed");var e=t&&"function"==typeof t.errorHandling&&t.errorHandling,n={};function r(n,r){var o=n instanceof Error?n:new Error(n);if(e)e(o);else{var i='[ERROR] callback-registry: User callback for key "'+r+'" failed: '+o.stack;if(t)switch(t.errorHandling){case"log":return console.error(i);case"silent":return;case"throw":throw new Error(i)}console.error(i)}}return{add:function(t,e){var r=n[t];return r||(r=[],n[t]=r),r.push(e),function(){var r=n[t];r&&(r=r.reduce((function(t,n,r){return n===e&&t.length===r||t.push(n),t}),[]),n[t]=r)}},execute:function(t){for(var e=[],o=1;o<arguments.length;o++)e[o-1]=arguments[o];var i=n[t];if(!i||0===i.length)return[];var s=[];return i.forEach((function(n){try{var o=n.apply(void 0,e);s.push(o)}catch(e){s.push(void 0),r(e,t)}})),s},clear:function(){n={}},clearKey:function(t){n[t]&&delete n[t]}}}k.default=k;var I=k,j=function(){function t(){this.callbacks={},this.registry=I()}return t.prototype.start=function(e,o){return n(this,void 0,void 0,(function(){var i=this;return r(this,(function(s){switch(s.label){case 0:return this.interop=e,this.logger=o,[4,this.interop.register(t.CONTROL_METHOD,(function(t){return n(i,void 0,void 0,(function(){var e,n,i;return r(this,(function(r){return e=t,o.trace("received control command "+JSON.stringify(e)),"windows"===e.domain?this.myWindow?(n=this.myWindow[e.command].call(this.myWindow,e.args),e.skipResult?[2,{}]:[2,n]):[2]:"appManager"===e.domain?this.myInstance?(n=this.myInstance[e.command].call(this.myInstance,e.args),e.skipResult?[2,{}]:[2,n]):[2]:("layouts"===e.domain&&(i=this.callbacks[e.domain])&&i(e),[2])}))}))}))];case 1:return s.sent(),this.registry.execute("started"),[2]}}))}))},t.prototype.send=function(e,n){if(!this.interop)throw new Error("Control not started");return this.logger.info("sending control command "+JSON.stringify(e)+" to "+JSON.stringify(n)+"}"),this.interop.invoke(t.CONTROL_METHOD,e,n)},t.prototype.subscribe=function(t,e){this.callbacks[t]=e},t.prototype.setLocalWindow=function(t){this.myWindow=t},t.prototype.setLocalInstance=function(t){this.myInstance=t},t.prototype.onStart=function(t){return this.registry.add("started",t)},t.CONTROL_METHOD="GC.Control",t}(),T=function(){function t(t,e,n,r,o){this.id=t,this.name=e,this.window=n,this.control=r,this.interop=o,this.context={},this.registry=I(),r.setLocalWindow(this)}return t.prototype.getURL=function(){return n(this,void 0,void 0,(function(){return r(this,(function(t){return[2,this.window.location.href]}))}))},t.prototype.moveResize=function(t){var e=t.left,o=t.top,i=t.width,s=t.height;return n(this,void 0,void 0,(function(){return r(this,(function(t){return e=null!=e?e:window.screenLeft,o=null!=o?o:window.screenTop,i=null!=i?i:window.outerWidth,s=null!=s?s:window.outerHeight,window.moveTo(e,o),window.resizeTo(i,s),[2,this]}))}))},t.prototype.close=function(){return n(this,void 0,void 0,(function(){return r(this,(function(t){if(!this.parent)throw new Error("can not close window if it's not opened by script");try{window.close()}catch(t){console.log("what")}return[2,this]}))}))},t.prototype.setTitle=function(t){return n(this,void 0,void 0,(function(){return r(this,(function(e){return"object"==typeof t&&null!==t&&(t=t.title),document.title=t,[2,this]}))}))},t.prototype.resizeTo=function(t,e){return n(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.moveResize({width:t,height:e})];case 1:return n.sent(),[2,this]}}))}))},t.prototype.moveTo=function(t,e){return n(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.moveResize({top:t,left:e})];case 1:return n.sent(),[2,this]}}))}))},t.prototype.focus=function(){return n(this,void 0,void 0,(function(){return r(this,(function(t){return window.focus(),[2,this]}))}))},t.prototype.getBounds=function(){return n(this,void 0,void 0,(function(){return r(this,(function(t){return[2,this.getBoundsSync()]}))}))},t.prototype.getContext=function(){return n(this,void 0,void 0,(function(){return r(this,(function(t){return[2,this.getContextSync()]}))}))},t.prototype.getContextSync=function(){return this.context},t.prototype.getTitle=function(){return n(this,void 0,void 0,(function(){return r(this,(function(t){return[2,this.window.document.title]}))}))},t.prototype.onContextUpdated=function(t){return this.registry.add("context-updated",t)},t.prototype.updateContext=function(t){var e=this.context;return this.context=Object.assign({},e,t),this.registry.execute("context-updated",this.context,e),Promise.resolve(this)},t.prototype.setContext=function(t){return n(this,void 0,void 0,(function(){var e;return r(this,(function(n){return e=this.context,this.context=Object.assign({},t),this.registry.execute("context-updated",t,e),[2,Promise.resolve(this)]}))}))},t.prototype.getBoundsSync=function(){return{left:this.window.screenLeft,top:this.window.screenTop,width:this.window.outerWidth,height:this.window.outerHeight}},t}(),M=function(e){function n(t,n,r,o,i){var s=e.call(this,n,r,o,i)||this;return s.window=t,s.id=n,s.name=r,s}return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}(n,e),n}(_),C=function(t){return'"GC.Wnd."'+t},O=function(){function t(t,e){this.interop=t,this.control=e,this.registry=I(),this.childWindows=[];var n=t.instance.windowId,r="document.title ("+x()+")";this.myWindow=new T(n,r,window,this.control,this.interop),this.trackWindowsLifetime()}return t.prototype.list=function(){var t=this,e=this.interop.methods({name:j.CONTROL_METHOD})[0];return e?(e.getServers?e.getServers():[]).reduce((function(e,n){var r=t.remoteFromServer(n);return r&&e.push(r),e}),[]):[]},t.prototype.findById=function(t){return this.list().find((function(e){return e.id===t}))},t.prototype.my=function(){return this.myWindow},t.prototype.open=function(t,e,o){var i,s,a,c,u;return n(this,void 0,void 0,(function(){var n,d,p,l,h,f,v,g,m,y,b,w,S;return r(this,(function(r){switch(r.label){case 0:return n=null!==(i=null==o?void 0:o.width)&&void 0!==i?i:400,d=null!==(s=null==o?void 0:o.height)&&void 0!==s?s:400,p=null!==(a=null==o?void 0:o.left)&&void 0!==a?a:window.screen.availWidth-window.screenLeft,l=null!==(c=null==o?void 0:o.top)&&void 0!==c?c:0,h=x(),function(t,e,n,r,o){var i,s=C(n),a={context:null!==(i=null==o?void 0:o.context)&&void 0!==i?i:{},name:r,parent:e};t.register(s,(function(){return a}))}(this.interop,this.my().id,h,t,o),(null==o?void 0:o.relativeTo)?(f=o.relativeTo,(v=this.list().find((function(t){return t.id===f})))?[4,v.getBounds()]:[3,2]):[3,2];case 1:g=r.sent(),m=null!==(u=o.relativeDirection)&&void 0!==u?u:"right",y=this.getRelativeBounds({width:n,height:d,left:p,top:l},g,m),n=y.width,d=y.height,p=y.left,l=y.top,r.label=2;case 2:if(b="width="+n+",height="+d+",left="+p+",top="+l+",scrollbars=none,location=no,status=no,menubar=no",!(w=window.open(e,h,b)))throw new Error("failed to open a window with url="+e+" and options="+b);return w.focus(),w.moveTo(p,l),w.resizeTo(n,d),S=new M(w,h,t,this.control,this),this.childWindows.push(S),[2,S]}}))}))},t.prototype.onWindowAdded=function(t){return this.registry.add("window-added",t)},t.prototype.onWindowRemoved=function(t){return this.registry.add("window-removed",t)},t.prototype.getChildWindows=function(){return this.childWindows=this.childWindows.filter((function(t){return!t.window.closed})),this.childWindows},t.prototype.remoteFromServer=function(t){var e;if(t.windowId)return new _(t.windowId,null!==(e=t.application)&&void 0!==e?e:"",this.control,this)},t.prototype.getRelativeBounds=function(t,e,n){switch(n){case"bottom":return{left:e.left,top:e.top+e.height+0,width:e.width,height:t.height};case"top":return{left:e.left,top:e.top-t.height-0,width:e.width,height:t.height};case"right":return{left:e.left+e.width+0,top:e.top,width:t.width,height:e.height};case"left":return{left:e.left-t.width-0,top:e.top,width:t.width,height:e.height}}throw new Error("invalid relativeDirection")},t.prototype.trackWindowsLifetime=function(){var t=this;this.interop.serverMethodAdded((function(e){var n=e.server;if(e.method.name===j.CONTROL_METHOD){var r=t.remoteFromServer(n);r&&t.registry.execute("window-added",r)}})),this.interop.serverRemoved((function(e){var n=t.remoteFromServer(e);n&&t.registry.execute("window-removed",n)}))},t}(),E=function(t){return{ok:!0,result:t}},P=function(t){return{ok:!1,error:t}},A=function(t){return!0===t.ok?Promise.resolve(t.result):Promise.reject(t.error)},L=function(t,e){return!0===e.ok?e.result:t},R=function(t){if(!0===t.ok)return t.result;throw t.error},N=function(t,e){return!0===e.ok?E(t(e.result)):e},D=function(t,e,n){return!1===e.ok?e:!1===n.ok?n:E(t(e.result,n.result))},q=function(t,e){return!0===e.ok?e:P(t(e.error))},F=function(t,e){return!0===e.ok?t(e.result):e},W=(Object.freeze({ok:E,isOk:function(t){return!0===t.ok},err:P,isErr:function(t){return!1===t.ok},asPromise:A,withDefault:L,withException:R,successes:function(t){return t.reduce((function(t,e){return!0===e.ok?t.concat(e.result):t}),[])},map:N,map2:D,mapError:q,andThen:F}),function(){return(W=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)});var B=function(t){return Array.isArray(t)},U=function(t){return"object"==typeof t&&null!==t&&!B(t)},H=function(t,e){return"expected "+t+", got "+function(t){switch(typeof t){case"string":return"a string";case"number":return"a number";case"boolean":return"a boolean";case"undefined":return"undefined";case"object":return t instanceof Array?"an array":null===t?"null":"an object";default:return JSON.stringify(t)}}(e)},K=function(t){return t.map((function(t){return"string"==typeof t?"."+t:"["+t+"]"})).join("")},J=function(t,e){var n=e.at,r=function(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(t);o<r.length;o++)e.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(t,r[o])&&(n[r[o]]=t[r[o]])}return n}(e,["at"]);return W({at:t+(n||"")},r)},G=function(){function t(e){var n=this;this.decode=e,this.run=function(t){return q((function(e){return{kind:"DecoderError",input:t,at:"input"+(e.at||""),message:e.message||""}}),n.decode(t))},this.runPromise=function(t){return A(n.run(t))},this.runWithException=function(t){return R(n.run(t))},this.map=function(e){return new t((function(t){return N(e,n.decode(t))}))},this.andThen=function(e){return new t((function(t){return F((function(n){return e(n).decode(t)}),n.decode(t))}))},this.where=function(e,r){return n.andThen((function(n){return e(n)?t.succeed(n):t.fail(r)}))}}return t.string=function(){return new t((function(t){return"string"==typeof t?E(t):P({message:H("a string",t)})}))},t.number=function(){return new t((function(t){return"number"==typeof t?E(t):P({message:H("a number",t)})}))},t.boolean=function(){return new t((function(t){return"boolean"==typeof t?E(t):P({message:H("a boolean",t)})}))},t.constant=function(e){return new t((function(t){return function t(e,n){if(e===n)return!0;if(null===e&&null===n)return!0;if(typeof e!=typeof n)return!1;if("object"==typeof e){if(Array.isArray(e)){if(!Array.isArray(n))return!1;if(e.length!==n.length)return!1;for(var r=0;r<e.length;r++)if(!t(e[r],n[r]))return!1;return!0}var o=Object.keys(e);if(o.length!==Object.keys(n).length)return!1;for(r=0;r<o.length;r++){if(!n.hasOwnProperty(o[r]))return!1;if(!t(e[o[r]],n[o[r]]))return!1}return!0}}(t,e)?E(e):P({message:"expected "+JSON.stringify(e)+", got "+JSON.stringify(t)})}))},t.object=function(e){return new t((function(t){if(U(t)&&e){var n={};for(var r in e)if(e.hasOwnProperty(r)){var o=e[r].decode(t[r]);if(!0!==o.ok)return void 0===t[r]?P({message:"the key '"+r+"' is required but was not present"}):P(J("."+r,o.error));void 0!==o.result&&(n[r]=o.result)}return E(n)}return U(t)?E(t):P({message:H("an object",t)})}))},t.array=function(e){return new t((function(t){if(B(t)&&e){return t.reduce((function(t,n,r){return D((function(t,e){return t.concat([e])}),t,function(t,n){return q((function(t){return J("["+n+"]",t)}),e.decode(t))}(n,r))}),E([]))}return B(t)?E(t):P({message:H("an array",t)})}))},t.tuple=function(e){return new t((function(t){if(B(t)){if(t.length!==e.length)return P({message:"expected a tuple of length "+e.length+", got one of length "+t.length});for(var n=[],r=0;r<e.length;r++){var o=e[r].decode(t[r]);if(!o.ok)return P(J("["+r+"]",o.error));n[r]=o.result}return E(n)}return P({message:H("a tuple of length "+e.length,t)})}))},t.union=function(e,n){for(var r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];return t.oneOf.apply(t,[e,n].concat(r))},t.intersection=function(e,n){for(var r=[],o=2;o<arguments.length;o++)r[o-2]=arguments[o];return new t((function(t){return[e,n].concat(r).reduce((function(e,n){return D(Object.assign,e,n.decode(t))}),E({}))}))},t.anyJson=function(){return new t((function(t){return E(t)}))},t.unknownJson=function(){return new t((function(t){return E(t)}))},t.dict=function(e){return new t((function(t){if(U(t)){var n={};for(var r in t)if(t.hasOwnProperty(r)){var o=e.decode(t[r]);if(!0!==o.ok)return P(J("."+r,o.error));n[r]=o.result}return E(n)}return P({message:H("an object",t)})}))},t.optional=function(e){return new t((function(t){return void 0===t?E(void 0):e.decode(t)}))},t.oneOf=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return new t((function(t){for(var n=[],r=0;r<e.length;r++){var o=e[r].decode(t);if(!0===o.ok)return o;n[r]=o.error}var i=n.map((function(t){return"at error"+(t.at||"")+": "+t.message})).join('", "');return P({message:'expected a value matching one of the decoders, got the errors ["'+i+'"]'})}))},t.withDefault=function(e,n){return new t((function(t){return E(L(e,n.decode(t)))}))},t.valueAt=function(e,n){return new t((function(t){for(var r=t,o=0;o<e.length;o++){if(void 0===r)return P({at:K(e.slice(0,o+1)),message:"path does not exist"});if("string"==typeof e[o]&&!U(r))return P({at:K(e.slice(0,o+1)),message:H("an object",r)});if("number"==typeof e[o]&&!B(r))return P({at:K(e.slice(0,o+1)),message:H("an array",r)});r=r[e[o]]}return q((function(t){return void 0===r?{at:K(e),message:"path does not exist"}:J(K(e),t)}),n.decode(r))}))},t.succeed=function(e){return new t((function(t){return E(e)}))},t.fail=function(e){return new t((function(t){return P({message:e})}))},t.lazy=function(e){return new t((function(t){return e().decode(t)}))},t}(),V=G.string,z=G.number,Y=G.boolean,X=G.anyJson,$=G.constant,Q=G.object,Z=G.array,tt=G.optional,et=G.oneOf,nt=G.lazy,rt=V().where((function(t){return t.length>0}),"Expected a non-empty string"),ot=Q({type:$("window"),config:Q({appName:rt,url:tt(rt)})}),it=Q({type:$("group"),config:X(),children:Z(et(ot))}),st=Q({type:$("column"),config:X(),children:Z(et(it,ot,nt((function(){return st})),nt((function(){return at}))))}),at=Q({type:$("row"),config:X(),children:Z(et(st,it,ot,nt((function(){return at}))))}),ct=Q({type:$("Workspace"),state:Q({config:X(),children:Z(et(at,st,it,ot))})}),ut=Q({type:$("window"),componentType:$("application"),state:Q({name:X(),context:X(),url:rt,bounds:X(),id:rt,parentId:tt(rt),main:Y()})}),dt=et($("Global"),$("Workspace")),pt=Q({name:rt,context:tt(X()),metadata:tt(X())}),lt=Q({name:rt,context:tt(X()),closeRunningInstance:tt(Y())}),ht=Q({name:rt,type:dt,context:tt(X()),metadata:tt(X()),components:Z(et(ct,ut))}),ft=function(){function t(t){this.controller=t}return t.prototype.getAll=function(t){return dt.runWithException(t),this.controller.getAll(t)},t.prototype.get=function(t,e){return rt.runWithException(t),dt.runWithException(e),this.controller.get(t,e)},t.prototype.export=function(t){return n(this,void 0,void 0,(function(){return r(this,(function(e){return t&&dt.runWithException(t),[2,this.controller.export(t)]}))}))},t.prototype.import=function(t){return t.forEach((function(t){return ht.runWithException(t)})),this.controller.import(t)},t.prototype.save=function(t){return pt.runWithException(t),this.controller.save(t)},t.prototype.restore=function(t){return lt.runWithException(t),this.controller.restore(t)},t.prototype.remove=function(t,e){return rt.runWithException(e),dt.runWithException(t),this.controller.remove(t,e)},t}(),vt=function(){function t(t){this.contexts=t}return t.prototype.subscribe=function(t){this.callback=t},t.prototype.subscribeFor=function(t,e){if(!this.isChannel(t))return Promise.reject(new Error("Channel with name: "+t+" doesn't exist!"));var n=this.createContextName(t);return this.contexts.subscribe(n,(function(t,n,r,o,i){e(t.data,t,null==i?void 0:i.updaterId)}))},t.prototype.switchChannel=function(t){return n(this,void 0,void 0,(function(){var e,n,o=this;return r(this,(function(r){switch(r.label){case 0:return this.unsubscribe(),e=this.createContextName(t),n=this,[4,this.contexts.subscribe(e,(function(t,e,n,r,i){o.callback&&o.callback(t.data,t,null==i?void 0:i.updaterId)}))];case 1:return n.unsubscribeFunc=r.sent(),[2]}}))}))},t.prototype.unsubscribe=function(){this.unsubscribeFunc&&this.unsubscribeFunc()},t.prototype.add=function(t,e){var n=this.createContextName(t);return this.contexts.set(n,e)},t.prototype.all=function(){return this.contexts.all().filter((function(t){return t.startsWith("___channel___")})).map((function(t){return t.substr("___channel___".length)}))},t.prototype.getContextData=function(t){var e=this;return new Promise((function(n,r){if(!e.isChannel(t))return r(new Error("A channel with name: "+t+" doesn't exist!"));var o=e.createContextName(t);e.contexts.subscribe(o,(function(t){n(t)})).then((function(t){return t()}))}))},t.prototype.update=function(t,e){var n=this.createContextName(t);return this.contexts.update(n,e)},t.prototype.createContextName=function(t){return"___channel___"+t},t.prototype.isChannel=function(t){return this.all().some((function(e){return e===t}))},t}(),gt=function(){function t(t,e){var n=this;this.subsKey="subs",this.changedKey="changed",this.registry=I(),this.shared=new vt(t),this.shared.subscribe(this.handler.bind(this)),this.readyPromise=Promise.resolve(null==e?void 0:e.reduce((function(t,e){return t.then((function(){return n.add(e)}))}),Promise.resolve({})))}return t.prototype.subscribe=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add(this.subsKey,t)},t.prototype.subscribeFor=function(t,e){return n(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:if("string"!=typeof t)throw new Error("Please provide the name as a string!");if("function"!=typeof e)throw new Error("Please provide the callback as a function!");return[4,this.shared.subscribeFor(t,e)];case 1:return[2,n.sent()]}}))}))},t.prototype.publish=function(t,e){return n(this,void 0,void 0,(function(){var n;return r(this,(function(r){switch(r.label){case 0:if("object"!=typeof t)throw new Error("Please provide the data as an object!");if(!e)return[3,2];if("string"!=typeof e)throw new Error("Please provide the name as a string!");return[4,this.get(e)];case 1:return n=r.sent(),[2,this.shared.update(n.name,{data:t})];case 2:if(!this.currentContext)throw new Error("Not joined to any channel!");return[2,this.shared.update(this.currentContext,{data:t})]}}))}))},t.prototype.all=function(){var t=this.shared.all();return Promise.resolve(t)},t.prototype.list=function(){return n(this,void 0,void 0,(function(){var t,e=this;return r(this,(function(n){switch(n.label){case 0:return[4,this.all()];case 1:return t=n.sent(),[4,Promise.all(t.map((function(t){return e.get(t)})))];case 2:return[2,n.sent()]}}))}))},t.prototype.get=function(t){return"string"!=typeof t?Promise.reject(new Error("Please provide the channel name as a string!")):this.shared.getContextData(t)},t.prototype.join=function(t){return n(this,void 0,void 0,(function(){var e,n=this;return r(this,(function(r){switch(r.label){case 0:if("string"!=typeof t)throw new Error("Please provide the channel name as a string!");return(e=function(t){return n.shared.all().includes(t)})(t)?[3,2]:[4,new Promise((function(n,r){var o,i=setInterval((function(){e(t)&&(clearTimeout(o),clearInterval(i),n())}),100);o=setTimeout((function(){return clearInterval(i),r(new Error("A channel with name: "+t+" doesn't exist!"))}),3e3)}))];case 1:r.sent(),r.label=2;case 2:return[4,this.shared.switchChannel(t)];case 3:return r.sent(),this.currentContext=t,this.registry.execute(this.changedKey,t),[2]}}))}))},t.prototype.leave=function(){return this.currentContext=void 0,this.registry.execute(this.changedKey,void 0),this.shared.unsubscribe(),Promise.resolve()},t.prototype.current=function(){return this.currentContext},t.prototype.my=function(){return this.current()},t.prototype.changed=function(t){if("function"!=typeof t)throw new Error("Please provide the callback as a function!");return this.registry.add(this.changedKey,t)},t.prototype.onChanged=function(t){return this.changed(t)},t.prototype.add=function(t){return n(this,void 0,void 0,(function(){var e;return r(this,(function(n){switch(n.label){case 0:if("object"!=typeof t)throw new Error("Please provide the info as an object!");if(void 0===t.name)throw new Error("info.name is missing!");if("string"!=typeof t.name)throw new Error("Please provide the info.name as a string!");if(void 0===t.meta)throw new Error("info.meta is missing!");if("object"!=typeof t.meta)throw new Error("Please provide the info.meta as an object!");if(void 0===t.meta.color)throw new Error("info.meta.color is missing!");if("string"!=typeof t.meta.color)throw new Error("Please provide the info.meta.color as a string!");return e={name:t.name,meta:t.meta||{},data:t.data||{}},[4,this.shared.update(t.name,e)];case 1:return n.sent(),[2,e]}}))}))},t.prototype.ready=function(){return this.readyPromise},t.prototype.handler=function(t,e,n){this.registry.execute(this.subsKey,t,e,n)},t}(),mt=function(t,e){return void 0===e&&(e=1e3),new Promise((function(n,r){var o=!1,i=setTimeout((function(){o=!0,r(new Error("Fetch request for: "+t+" timed out at: "+e+" milliseconds"))}),e);fetch(t).then((function(t){o||(clearTimeout(i),n(t))})).catch((function(t){o||(clearTimeout(i),r(t))}))}))},yt=function(){function t(t,e,n){var r,o,i=this;this._appManager=t,this._props=e,this._windows=n,this._registry=I();var s=void 0!==(null===(r=null==e?void 0:e.userProperties)||void 0===r?void 0:r.manifest)?JSON.parse(null==e?void 0:e.userProperties.manifest).url:null===(o=null==e?void 0:e.userProperties)||void 0===o?void 0:o.details.url;this._url=s,t.onInstanceStarted((function(t){t.application.name===i.name&&i._registry.execute("instanceStarted",t)})),t.onInstanceStopped((function(t){t.application.name===i.name&&i._registry.execute("instanceStopped",t)}))}return Object.defineProperty(t.prototype,"name",{get:function(){return this._props.name},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"title",{get:function(){return this._props.title||""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"version",{get:function(){return this._props.version||""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"userProperties",{get:function(){return this._props.userProperties||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"instances",{get:function(){var t=this;return this._appManager.instances().filter((function(e){return e.application.name===t.name}))},enumerable:!0,configurable:!0}),t.prototype.start=function(t,n){var r=this;return new Promise((function(o,i){var s,a,c,u=setTimeout((function(){c(),i('Application "'+r.name+'" start timeout!')}),3e3);c=r._appManager.onInstanceStarted((function(t){t.application.name===r.name&&(clearTimeout(u),c(),o(t))}));var d=e(e(e({},null===(a=null===(s=r._props)||void 0===s?void 0:s.userProperties)||void 0===a?void 0:a.details),n),{context:t||(null==n?void 0:n.context)});if(!r._url)throw new Error("Application "+r.name+" doesn't have a URL.");r._windows.open(r.name,r._url,d)}))},t.prototype.onInstanceStarted=function(t){this._registry.add("instanceStarted",t)},t.prototype.onInstanceStopped=function(t){this._registry.add("instanceStopped",t)},t.prototype.updateFromProps=function(t){var e,n,r=this,o=void 0!==(null===(e=null==t?void 0:t.userProperties)||void 0===e?void 0:e.manifest)?JSON.parse(null==t?void 0:t.userProperties.manifest).url:null===(n=null==t?void 0:t.userProperties)||void 0===n?void 0:n.details.url;this._url=o,Object.keys(t).forEach((function(e){r._props[e]=t[e]}))},t}(),bt=function(){function t(t,e,n,r,o){this.id=t,this.application=e,this.control=n,this.context=r,this.agm=o,this.WINDOW_DID_NOT_HAVE_TIME_TO_RESPOND="Peer has left while waiting for result"}return t.prototype.stop=function(){return n(this,void 0,void 0,(function(){var t;return r(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,this.callControl("stop",{},!1)];case 1:return e.sent(),[3,3];case 2:if((t=e.sent()).message!==this.WINDOW_DID_NOT_HAVE_TIME_TO_RESPOND)throw new Error(t);return[3,3];case 3:return[2]}}))}))},t.prototype.callControl=function(t,e,n){return void 0===n&&(n=!1),this.control.send({command:t,domain:"appManager",args:e,skipResult:n},{instance:this.id})},t}(),wt=function(){function t(t,e,n,r){this.id=t,this.control=e,this._appManager=n,this.agm=r,this.context={},this.startedByScript=!1,this.application=void 0,e.setLocalInstance(this)}return t.prototype.stop=function(){var t=this;return new Promise((function(e,n){if(t.startedByScript){var r=t._appManager.onInstanceStopped((function(n){n.id===t.id&&(r(),e())}));window.close()}else n("Can't close a window that wasn't started by a script.")}))},t}(),St=V().where((function(t){return t.length>0}),"Expected a non-empty string"),xt=Q({url:tt(St)}),_t=Q({icon:tt(St)}),kt=Q({name:St,displayName:tt(V()),contexts:tt(Z(V())),customConfig:tt(Q())}),It=Q({url:St,top:tt(z()),left:tt(z()),width:tt(z()),height:tt(z()),context:tt(X()),relativeTo:tt(St),relativeDirection:tt(et($("top"),$("left"),$("right"),$("bottom")))}),jt=Q({name:St,title:tt(V()),version:tt(V()),appId:St,manifest:St,manifestType:St,tooltip:tt(V()),description:tt(V()),contactEmail:tt(V()),supportEmail:tt(V()),publisher:tt(V()),images:tt(Z(xt)),icons:tt(Z(_t)),customConfig:tt(Q()),intents:tt(Z(kt))}),Tt=Q({name:St,title:tt(V()),version:tt(V()),details:It,customProperties:tt(Q())}),Mt=function(){function t(t,e,n,r,o){var i=this;this.windows=t,this.interop=e,this.control=n,this.config=r,this.appName=o,this._apps={},this._instances=[],this.registry=I(),this.DEFAULT_POLLING_INTERVAL=3e3,this.OKAY_MESSAGE="OK",this.LOCAL_SOURCE="LOCAL_SOURCE";var s=e.instance.instance;if(this._myInstance=new wt(s,this.control,this,this.interop.instance),(null==r?void 0:r.remoteSources)&&this.subscribeForRemoteApplications(r.remoteSources),null==r?void 0:r.localApplications){var a=this.getValidatedApplications(r.localApplications);this.addApplications(a)}n.onStart((function(){i.trackInstanceLifetime()}))}return Object.defineProperty(t.prototype,"myInstance",{get:function(){return this.appName||console.warn("application wasn't provided to the GlueWeb factory function!"),this._myInstance||console.warn("The application isn't defined in any of the local/remote application sources!"),this._myInstance},enumerable:!0,configurable:!0}),t.prototype.application=function(t){return this._apps[t].application},t.prototype.applications=function(){var t=this;return Object.keys(this._apps).map((function(e){return t._apps[e].application}))},t.prototype.instances=function(){return this._instances},t.prototype.onAppAdded=function(t){var e=this,n=Object.keys(this._apps).map((function(t){return e._apps[t].application}));return this.replay(n,t),this.registry.add("appAdded",t)},t.prototype.onAppRemoved=function(t){return this.registry.add("appRemoved",t)},t.prototype.onAppChanged=function(t){return this.registry.add("appChanged",t)},t.prototype.onInstanceStarted=function(t){return this.registry.add("instanceStarted",t)},t.prototype.onInstanceStopped=function(t){return this.registry.add("instanceStopped",t)},t.prototype.getValidatedApplications=function(t){return t.filter((function(t){var e;return(e=void 0!==t.manifest?jt.run(t).ok:Tt.run(t).ok)||console.warn('Validation failed for application "'+t.name+'"!'),e}))},t.prototype.subscribeForRemoteApplications=function(t){for(var e=this,n=function(t){var n=t.url,o=function(){mt(n).then((function(t){return t.json()})).then((function(t){if(t.message===e.OKAY_MESSAGE){var r=e.getValidatedApplications(t.applications);e.addApplications(r,n)}})).catch((function(t){console.warn(t)}))};o(),setInterval(o,t.pollingInterval||r.DEFAULT_POLLING_INTERVAL)},r=this,o=0,i=t;o<i.length;o++){n(i[o])}},t.prototype.getAppProps=function(t){var e=["name","title","version"],n=Object.fromEntries(Object.entries(t).filter((function(t){var n=t[0];return!e.includes(n)})));return{name:t.name,title:t.title,version:t.version,userProperties:n}},t.prototype.handleAppsChanged=function(t,e){for(var n=this,r=function(t){var r=Object.keys(o._apps).find((function(r){return r===t.name&&n._apps[r].source===e})),i=Object.keys(o._apps).find((function(r){return r===t.name&&n._apps[r].source!==e}));if(r){var s=o._apps[r],a=o.getAppProps(t);if(JSON.stringify(s.appProps)!==JSON.stringify(a)){var c=new yt(o,a,o.windows);o.registry.execute("appChanged",c),o._apps[t.name]={source:s.source,application:c,appProps:a}}}else i&&console.warn('Application "'+t.name+'" already defined by source "'+o._apps[i].source+'". Skipping application definition from source '+e+".")},o=this,i=0,s=t;i<s.length;i++){r(s[i])}},t.prototype.handleAppsAdded=function(t,e){for(var n=Object.keys(this._apps),r=0,o=t.filter((function(t){return!n.includes(t.name)}));r<o.length;r++){var i=o[r],s=this.getAppProps(i),a=new yt(this,s,this.windows);this.registry.execute("appAdded",a),this._apps[i.name]={source:e||this.LOCAL_SOURCE,application:a,appProps:s}}},t.prototype.handleAppsRemoved=function(t,e){for(var n=this,r=Object.keys(this._apps).filter((function(t){return n._apps[t].source===e})).map((function(t){return n._apps[t].application})),o=t.map((function(t){return t.name})),i=0,s=r.filter((function(t){return!o.includes(t.name)}));i<s.length;i++){var a=s[i];this.registry.execute("appRemoved",a),delete this._apps[a.name]}},t.prototype.tryPopulateMyInstanceApplication=function(){var t,e=this;if(this.appName){var n=null===(t=Object.values(this._apps).find((function(t){return t.application.name===e.appName})))||void 0===t?void 0:t.application;n&&(n.title&&(document.title=n.title),this._myInstance.application=n)}},t.prototype.addApplications=function(t,e){this.handleAppsChanged(t,e),this.handleAppsAdded(t,e),this.handleAppsRemoved(t,e),this._myInstance.application||this.tryPopulateMyInstanceApplication()},t.prototype.replay=function(t,e){(Array.isArray(t)?t:Object.values(t)).forEach((function(t){return e(t)}))},t.prototype.remoteFromServer=function(t){return n(this,void 0,void 0,(function(){var e,n,o,i,s;return r(this,(function(r){switch(r.label){case 0:return e=t.application,t.instance&&e&&this._apps[e]?(n=t.instance,o=this._apps[e].application,[4,null==(i=this.windows.list().find((function(e){return e.id===t.windowId})))?void 0:i.getContext()]):[2,void 0];case 1:return s=r.sent(),[2,new bt(n,o,this.control,s,t)]}}))}))},t.prototype.trackInstanceLifetime=function(){var t=this;this.interop.serverMethodAdded((function(e){var o=e.server,i=e.method;return n(t,void 0,void 0,(function(){var t;return r(this,(function(e){switch(e.label){case 0:return i.name!==j.CONTROL_METHOD?[2]:[4,this.remoteFromServer(o)];case 1:return(t=e.sent())&&(this._instances.push(t),this.registry.execute("instanceStarted",t)),[2]}}))}))})),this.interop.serverRemoved((function(e){return n(t,void 0,void 0,(function(){var t;return r(this,(function(n){switch(n.label){case 0:return[4,this.remoteFromServer(e)];case 1:return(t=n.sent())&&(this._instances=this._instances.filter((function(e){return e.id!==t.id})),this.registry.execute("instanceStopped",t)),[2]}}))}))}))},t}(),Ct=function(){function t(t){this.interop=t}return t.prototype.raise=function(t){return n(this,void 0,void 0,(function(){var e,n,o=this;return r(this,(function(r){switch(r.label){case 0:if(!("Notification"in window))throw new Error("this browser does not support desktop notification");return[4,"granted"===Notification.permission?Promise.resolve("granted"):"denied"===Notification.permission?Promise.reject("no permissions from user"):Notification.requestPermission()];case 1:return r.sent(),e=this.raiseUsingWebApi(t),t.clickInterop&&(n=t.clickInterop,e.onclick=function(){var t,e;o.interop.invoke(n.method,null!==(t=null==n?void 0:n.arguments)&&void 0!==t?t:{},null!==(e=null==n?void 0:n.target)&&void 0!==e?e:"best")}),[2,e]}}))}))},t.prototype.raiseUsingWebApi=function(t){return new Notification(t.title,t)},t}(),Ot={layouts:{autoRestore:!1,autoSaveWindowContext:!1},logger:"error",assets:{location:"/glue"},channels:!1,appManager:!1,libraries:[]},Et=function(t){return n(void 0,void 0,void 0,(function(){var e,n,o,i,s;return r(this,(function(r){switch(r.label){case 0:if(!1===(null===(i=t.assets)||void 0===i?void 0:i.extendConfig)||!1===t.extends)return[2,{}];e=(null===(s=t.assets)||void 0===s?void 0:s.location)?t.assets.location+"/glue.config.json":"string"==typeof t.extends?t.extends:"/glue/glue.config.json",r.label=1;case 1:return r.trys.push([1,4,,5]),[4,mt(e)];case 2:return(n=r.sent()).ok?[4,n.json()]:[2,{}];case 3:return[2,null!=(o=r.sent())?o:{}];case 4:return r.sent(),[2,{}];case 5:return[2]}}))}))},Pt=function(){function t(t,e,n,r,o){var i,s;this.storage=t,this.windows=e,this.control=n,this.interop=r,this.autoSaveContext=null!==(s=null===(i=null==o?void 0:o.layouts)||void 0===i?void 0:i.autoSaveWindowContext)&&void 0!==s&&s,this.control.subscribe("layouts",this.handleControlMessage.bind(this)),this.registerRequestMethods()}return t.prototype.export=function(t){return n(this,void 0,void 0,(function(){var e,n,o;return r(this,(function(r){switch(r.label){case 0:return t?[2,this.storage.getAll(t)]:[4,Promise.all([this.storage.getAll("Global"),this.storage.getAll("Workspace")])];case 1:return e=r.sent(),n=e[0],o=e[1],[2,n.concat(o)]}}))}))},t.prototype.import=function(t){return n(this,void 0,void 0,(function(){var e=this;return r(this,(function(n){switch(n.label){case 0:return[4,Promise.all(t.map((function(t){return e.storage.store(t,t.type)})))];case 1:return n.sent(),[2]}}))}))},t.prototype.save=function(t,e){return void 0===e&&(e=!1),n(this,void 0,void 0,(function(){var n,o,i;return r(this,(function(r){switch(r.label){case 0:return n=this.windows.getChildWindows().map((function(t){return t.id})),[4,this.getRemoteWindowsInfo(n)];case 1:return(o=r.sent()).push(this.getLocalLayoutComponent(t.context,!0)),i={type:"Global",name:t.name,components:o,context:t.context||{},metadata:t.metadata||{}},e?(this.storage.storeAutoLayout(i),[3,4]):[3,2];case 2:return[4,this.storage.store(i,"Global")];case 3:r.sent(),r.label=4;case 4:return[2,i]}}))}))},t.prototype.autoSave=function(t){return n(this,void 0,void 0,(function(){return r(this,(function(e){return[2,this.save(t,!0)]}))}))},t.prototype.restore=function(t){return n(this,void 0,void 0,(function(){var e;return r(this,(function(n){switch(n.label){case 0:return[4,this.storage.get(t.name,"Global")];case 1:if(!(e=n.sent()))throw new Error("can not find layout with name "+t.name);return this.restoreComponents(e),[2]}}))}))},t.prototype.restoreAutoSavedLayout=function(){return n(this,void 0,void 0,(function(){var t,e,n,o;return r(this,(function(r){switch(r.label){case 0:return t="_auto_"+document.location.href,[4,this.storage.getAutoLayout(t)];case 1:if(!(e=r.sent()))return[2,Promise.resolve()];if((n=this.windows.my()).parent)return[2];o=e.components.find((function(t){return t.state.main})),n.setContext(null==o?void 0:o.state.context);try{this.restoreComponents(e)}catch(t){return[2]}return[2]}}))}))},t.prototype.remove=function(t,e){return this.storage.remove(e,t)},t.prototype.getAll=function(t){return n(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:return[4,this.storage.getAll(t)];case 1:return[2,e.sent().map((function(t){return{name:t.name,type:t.type,context:t.context,metadata:t.metadata}}))]}}))}))},t.prototype.get=function(t,e){return this.storage.get(t,e)},t.prototype.getLocalLayoutComponent=function(t,e){var n;void 0===e&&(e=!1);var r=this.windows.my();try{this.autoSaveContext&&(n={windowContext:r.getContextSync()})}catch(t){}return{type:"window",componentType:"application",state:{name:r.name,context:(null==n?void 0:n.windowContext)||{},bounds:r.getBoundsSync(),url:window.document.location.href,id:r.id,parentId:r.parent,main:e}}},t.prototype.restoreComponents=function(t){var n=this;t.components.forEach((function(t){if("window"===t.type){var r=t.state;if(r.main)return;var o=e(e({},r.bounds),{context:r.context});n.windows.open(r.name,r.url,o)}}))},t.prototype.getRemoteWindowsInfo=function(t){return n(this,void 0,void 0,(function(){var e,n,o,i,s,a;return r(this,(function(r){switch(r.label){case 0:for(e=[],n=function(t){var n=o.interop.servers().find((function(e){return e.windowId===t}));if(!n||!n.getMethods)return"continue";if(n.getMethods().find((function(t){return"T42.HC.GetSaveContext"===t.name})))try{e.push(o.interop.invoke("T42.HC.GetSaveContext",{},{windowId:t}))}catch(t){}},o=this,i=0,s=t;i<s.length;i++)a=s[i],n(a);return[4,Promise.all(e)];case 1:return[2,r.sent().map((function(t){return t.returned}))]}}))}))},t.prototype.registerRequestMethods=function(){var t=this;this.interop.register("T42.HC.GetSaveContext",(function(e){return t.getLocalLayoutComponent(e)}))},t.prototype.handleControlMessage=function(t){return n(this,void 0,void 0,(function(){var e,n,o,i=this;return r(this,(function(r){switch(r.label){case 0:return"saveLayoutAndClose"!==(e=t).command?[3,3]:(n=e.args,[4,this.getRemoteWindowsInfo(n.childWindows)]);case 1:return(o=r.sent()).push(n.parentInfo),[4,this.storage.storeAutoLayout({type:"Global",name:n.layoutName,components:o,context:n.context||{},metadata:n.metadata||{}})];case 2:r.sent(),n.childWindows.forEach((function(t){var e;null===(e=i.windows.findById(t))||void 0===e||e.close()})),r.label=3;case 3:return[2]}}))}))},t}(),At=function(){function t(t,e,n){this.localStore=t,this.autoStore=e,this.remoteStore=n}return t.prototype.get=function(t,e){var o;return n(this,void 0,void 0,(function(){var n,i;return r(this,(function(r){switch(r.label){case 0:return[4,null===(o=this.remoteStore)||void 0===o?void 0:o.get(t,e)];case 1:return n=r.sent(),[4,this.localStore.get(t,e)];case 2:return i=r.sent(),n&&i?[2,n]:[2,n||i]}}))}))},t.prototype.getAll=function(t){return n(this,void 0,void 0,(function(){var e,n,o,i,s=this;return r(this,(function(r){switch(r.label){case 0:return[4,Promise.all([this.localStore.getAll(t),new Promise((function(e){if(s.remoteStore)return s.remoteStore.getAll(t).then(e);e([])}))])];case 1:return e=r.sent(),n=e[0],o=e[1],i=n.filter((function(t){return!o.some((function(e){return e.name===t.name}))})),[2,o.concat(i)]}}))}))},t.prototype.store=function(t,e){var o;return n(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,null===(o=this.remoteStore)||void 0===o?void 0:o.get(t.name,e)];case 1:if(n.sent())throw new Error("Cannot save layout with name: "+t.name+" and type: "+e+", because it is present in the remote store and is treated as readonly");return t.metadata?t.metadata.allowSave=!0:t.metadata={allowSave:!0},[4,this.localStore.store(t,e)];case 2:return n.sent(),[2]}}))}))},t.prototype.remove=function(t,e){var o;return n(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,null===(o=this.remoteStore)||void 0===o?void 0:o.get(t,e)];case 1:if(n.sent())throw new Error("Cannot remove layout with name: "+t+" and type: "+e+", because it is present in the remote store and is treated as readonly");return[4,this.localStore.delete(t,e)];case 2:return n.sent(),[2]}}))}))},t.prototype.getAutoLayout=function(t){return this.autoStore.get(t,"Global")},t.prototype.storeAutoLayout=function(t){this.autoStore.save(t)},t}();let Lt,Rt;const Nt=new WeakMap,Dt=new WeakMap,qt=new WeakMap,Ft=new WeakMap,Wt=new WeakMap;let Bt={get(t,e,n){if(t instanceof IDBTransaction){if("done"===e)return Dt.get(t);if("objectStoreNames"===e)return t.objectStoreNames||qt.get(t);if("store"===e)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return Kt(t[e])},set:(t,e,n)=>(t[e]=n,!0),has:(t,e)=>t instanceof IDBTransaction&&("done"===e||"store"===e)||e in t};function Ut(t){return t!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(Rt||(Rt=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(Jt(this),e),Kt(Nt.get(this))}:function(...e){return Kt(t.apply(Jt(this),e))}:function(e,...n){const r=t.call(Jt(this),e,...n);return qt.set(r,e.sort?e.sort():[e]),Kt(r)}}function Ht(t){return"function"==typeof t?Ut(t):(t instanceof IDBTransaction&&function(t){if(Dt.has(t))return;const e=new Promise((e,n)=>{const r=()=>{t.removeEventListener("complete",o),t.removeEventListener("error",i),t.removeEventListener("abort",i)},o=()=>{e(),r()},i=()=>{n(t.error||new DOMException("AbortError","AbortError")),r()};t.addEventListener("complete",o),t.addEventListener("error",i),t.addEventListener("abort",i)});Dt.set(t,e)}(t),((t,e)=>e.some(e=>t instanceof e))(t,Lt||(Lt=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(t,Bt):t)}function Kt(t){if(t instanceof IDBRequest)return function(t){const e=new Promise((e,n)=>{const r=()=>{t.removeEventListener("success",o),t.removeEventListener("error",i)},o=()=>{e(Kt(t.result)),r()},i=()=>{n(t.error),r()};t.addEventListener("success",o),t.addEventListener("error",i)});return e.then(e=>{e instanceof IDBCursor&&Nt.set(e,t)}).catch(()=>{}),Wt.set(e,t),e}(t);if(Ft.has(t))return Ft.get(t);const e=Ht(t);return e!==t&&(Ft.set(t,e),Wt.set(e,t)),e}const Jt=t=>Wt.get(t);const Gt=["get","getKey","getAll","getAllKeys","count"],Vt=["put","add","delete","clear"],zt=new Map;function Yt(t,e){if(!(t instanceof IDBDatabase)||e in t||"string"!=typeof e)return;if(zt.get(e))return zt.get(e);const n=e.replace(/FromIndex$/,""),r=e!==n,o=Vt.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!o&&!Gt.includes(n))return;const i=async function(t,...e){const i=this.transaction(t,o?"readwrite":"readonly");let s=i.store;r&&(s=s.index(e.shift()));const a=await s[n](...e);return o&&await i.done,a};return zt.set(e,i),i}Bt=(t=>({...t,get:(e,n,r)=>Yt(e,n)||t.get(e,n,r),has:(e,n)=>!!Yt(e,n)||t.has(e,n)}))(Bt);var Xt=function(){function t(){if(!("indexedDB"in window))throw new Error("Cannot initialize the local storage, because IndexedDb is not supported")}return Object.defineProperty(t.prototype,"database",{get:function(){var t=this;return this._database?Promise.resolve(this._database):new Promise((function(e){(function(t,e,{blocked:n,upgrade:r,blocking:o,terminated:i}={}){const s=indexedDB.open(t,e),a=Kt(s);return r&&s.addEventListener("upgradeneeded",t=>{r(Kt(s.result),t.oldVersion,t.newVersion,Kt(s.transaction))}),n&&s.addEventListener("blocked",()=>n()),a.then(t=>{i&&t.addEventListener("close",()=>i()),o&&t.addEventListener("versionchange",()=>o())}).catch(()=>{}),a})("glue42core",1,{upgrade:t.setUpDb.bind(t)}).then((function(n){t._database=n,e(t._database)}))}))},enumerable:!0,configurable:!0}),t.prototype.getAll=function(t){return n(this,void 0,void 0,(function(){return r(this,(function(e){switch(e.label){case 0:switch(t){case"Workspace":return[3,1];case"Global":return[3,3]}return[3,5];case 1:return[4,this.database];case 2:return[2,e.sent().getAll("workspaceLayouts")];case 3:return[4,this.database];case 4:return[2,e.sent().getAll("globalLayouts")];case 5:throw new Error("The provided layout type is not recognized: "+t)}}))}))},t.prototype.delete=function(t,e){return n(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:switch(e){case"Workspace":return[3,1];case"Global":return[3,3]}return[3,5];case 1:return[4,this.database];case 2:return[2,n.sent().delete("workspaceLayouts",t)];case 3:return[4,this.database];case 4:return[2,n.sent().delete("globalLayouts",t)];case 5:throw new Error("The provided layout type is not recognized: "+e)}}))}))},t.prototype.get=function(t,e){return n(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:switch(e){case"Workspace":return[3,1];case"Global":return[3,3]}return[3,5];case 1:return[4,this.database];case 2:return[2,n.sent().get("workspaceLayouts",t)];case 3:return[4,this.database];case 4:return[2,n.sent().get("globalLayouts",t)];case 5:throw new Error("The provided layout type is not recognized: "+e)}}))}))},t.prototype.store=function(t,e){return n(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:switch(ht.runWithException(t),dt.runWithException(e),e){case"Workspace":return[3,1];case"Global":return[3,3]}return[3,5];case 1:return[4,this.database];case 2:return[2,n.sent().put("workspaceLayouts",t,t.name)];case 3:return[4,this.database];case 4:return[2,n.sent().put("globalLayouts",t,t.name)];case 5:throw new Error("The provided layout type is not recognized: "+e)}}))}))},t.prototype.setUpDb=function(t){t.objectStoreNames.contains("workspaceLayouts")||t.createObjectStore("workspaceLayouts"),t.objectStoreNames.contains("globalLayouts")||t.createObjectStore("globalLayouts")},t}(),$t=function(){function t(t){this.storeBaseUrl=t}return t.prototype.getAll=function(t){return n(this,void 0,void 0,(function(){var e,n,o;return r(this,(function(r){switch(r.label){case 0:return dt.runWithException(t),e=this.storeBaseUrl+"/glue.layouts.json",[4,this.fetchTimeout(e)];case 1:if(!(n=r.sent()).ok)return[2,[]];r.label=2;case 2:return r.trys.push([2,4,,5]),[4,n.json()];case 3:return o=r.sent(),[3,5];case 4:return r.sent(),[2,[]];case 5:return o?[2,(o["Global"===t?"globals":"workspaces"]||[]).filter((function(t){var e=ht.run(t);return e.ok||console.warn("Fetched layout: "+t.name+" is discarded, because it failed the validation: "+JSON.stringify(e)),e.ok}))]:[2,[]]}}))}))},t.prototype.get=function(t,e){return n(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:return[4,this.getAll(e)];case 1:return[2,n.sent().find((function(e){return e.name===t}))]}}))}))},t.prototype.fetchTimeout=function(t,e){return void 0===e&&(e=1e3),new Promise((function(n,r){var o=!1,i=setTimeout((function(){o=!0,r(new Error("Fetch request for: "+t+" timed out at: "+e+" milliseconds"))}),e);fetch(t).then((function(t){o||(clearTimeout(i),n(t))})).catch((function(t){o||(clearTimeout(i),r(t))}))}))},t}(),Qt=function(){function t(){}return t.prototype.get=function(t,e){return this.getObjectFromLocalStorage()[this.getKey(t,e)]},t.prototype.save=function(t){var e=this.getObjectFromLocalStorage();return e[this.getKey(t.name,t.type)]=t,this.setObjectToLocalStorage(e),t},t.prototype.remove=function(t,e){delete this.getObjectFromLocalStorage()[this.getKey(t,e)]},t.prototype.getObjectFromLocalStorage=function(){var e=window.localStorage.getItem(t.KEY);return e?JSON.parse(e):{}},t.prototype.setObjectToLocalStorage=function(e){window.localStorage.setItem(t.KEY,JSON.stringify(e))},t.prototype.getKey=function(t,e){return e+"_"+t},t.KEY="G0_layouts",t}(),Zt=function(t,e,o,i){var s=!1;window.addEventListener("beforeunload",(function(){n(void 0,void 0,void 0,(function(){var n,a,c,u,d;return r(this,(function(r){return s||(s=!0,(null===(d=null==e?void 0:e.layouts)||void 0===d?void 0:d.autoRestore)&&(n=t.windows.getChildWindows().map((function(t){return t.id})),a=n[0],c="_auto_"+document.location.href,n.length>0?(u={domain:"layouts",command:"saveLayoutAndClose",args:{childWindows:n,closeEveryone:!0,layoutName:c,context:{},metadata:{},parentInfo:null==i?void 0:i.getLocalLayoutComponent({},!0)}},o.send(u,{windowId:a})):null==i||i.autoSave({name:c})),t.done()),[2]}))}))}))},te=function(t,e){return(te=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function ee(t,e){function n(){this.constructor=t}te(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var ne=function(){return(ne=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function re(t,e,n,r){return new(n||(n=Promise))((function(o,i){function s(t){try{c(r.next(t))}catch(t){i(t)}}function a(t){try{c(r.throw(t))}catch(t){i(t)}}function c(t){t.done?o(t.value):new n((function(e){e(t.value)})).then(s,a)}c((r=r.apply(t,e||[])).next())}))}function oe(t,e){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=e.call(t,s)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}function ie(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),o=0;for(e=0;e<n;e++)for(var i=arguments[e],s=0,a=i.length;s<a;s++,o++)r[o]=i[s];return r}var se=1,ae=2,ce=3,ue=4;function de(t){return t.type===ce?"timestamp":t.type===ae?"number":t.type===se?"string":t.type===ue?"object":"unknown"}function pe(t){return t.constructor===Date?"timestamp":"number"==typeof t?"number":"string"==typeof t?"string":"object"==typeof t?"object":"string"}function le(t){var e={},n=de(t);if("object"===n){var r=Object.keys(t.value).reduce((function(e,n){var r=pe(t.value[n]);if("object"===r){var o=function t(e){return Object.keys(e).reduce((function(n,r){var o=pe(e[r]);return n[r]="object"===o?{type:"object",description:"",context:{},composite:t(e[r])}:{type:o,description:"",context:{}},n}),{})}(t.value[n]);e[n]={type:"object",description:"",context:{},composite:o}}else e[n]={type:r,description:"",context:{}};return e}),{});e.composite=r}return e.name=he(t.path.join("/")+"/"+t.name),e.type=n,e.description=t.description,e.context={},e}function he(t){return void 0!==t&&t.length>0&&"/"!==t[0]?"/"+t:t}function fe(t){return"timestamp"===de(t)?Date.now():function t(e){if("object"!=typeof e)return e;return Object.keys(e).reduce((function(n,r){var o=e[r];return"object"==typeof o&&o.constructor!==Date?n[r]=t(o):o.constructor===Date?n[r]=new Date(o).getTime():o.constructor===Boolean?n[r]=o.toString():n[r]=o,n}),{})}(t.value)}function ve(t){var e=function t(e){return e.reduce((function(e,n){return e.concat(Array.isArray(n)?t(n):n)}),[])}(t.root.getAggregateState()),n=e.sort((function(t,e){return t.state?e.state?e.state-t.state:-1:1}))[0];return{description:function(t){var e="";return t.forEach((function(t,n,r){var o=t.path.join(".");n===r.length-1?e+=o+"."+t.name+": "+t.description:e+=o+"."+t.name+": "+t.description+","})),e.length>100?e.slice(0,100)+"...":e}(e),value:n.state}}var ge=function(t,e,n){if(null===t||"object"!=typeof t)throw new Error("Missing definition");if(null===e||"object"!=typeof e)throw new Error("Missing parent");if(null===n||"object"!=typeof n)throw new Error("Missing transport")},me=function(){function t(t,e,n,r,o){this.definition=t,this.system=e,this.transport=n,this.value=r,this.type=o,this.path=[],ge(t,e,n),this.path=e.path.slice(0),this.path.push(e.name),this.name=t.name,this.description=t.description,n.createMetric(this)}return Object.defineProperty(t.prototype,"repo",{get:function(){var t;return null===(t=this.system)||void 0===t?void 0:t.repo},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"id",{get:function(){return this.system.path+"/"+name},enumerable:!0,configurable:!0}),t.prototype.update=function(t){this.value=t,this.transport.updateMetric(this)},t}(),ye=function(t){function e(e,n,r,o){return t.call(this,e,n,r,o,ae)||this}return ee(e,t),e.prototype.incrementBy=function(t){this.update(this.value+t)},e.prototype.increment=function(){this.incrementBy(1)},e.prototype.decrement=function(){this.incrementBy(-1)},e.prototype.decrementBy=function(t){this.incrementBy(-1*t)},e}(me),be=function(t){function e(e,n,r,o){return t.call(this,e,n,r,o,ue)||this}return ee(e,t),e.prototype.update=function(t){this.mergeValues(t),this.transport.updateMetric(this)},e.prototype.mergeValues=function(t){var e=this;return Object.keys(this.value).forEach((function(n){void 0!==t[n]&&(e.value[n]=t[n])}))},e}(me),we=function(t){function e(e,n,r,o){return t.call(this,e,n,r,o,se)||this}return ee(e,t),e}(me),Se=function(t){function e(e,n,r,o){return t.call(this,e,n,r,o,ce)||this}return ee(e,t),e.prototype.now=function(){this.update(new Date)},e}(me);var xe=function(){function t(t,e){e.init(this),this.root=function t(e,n,r,o,i){if(!n)throw new Error("Repository is required");if(!r)throw new Error("Transport is required");var s,a,c=r,u=e,d=i||"",p=n,l=o,h=function t(e){if(!e||!e.parent)return[];var n=t(e.parent);return n.push(e.name),n}(o),f={},v=(a="/",((s=h)&&s.length>0?s.join(a):"")+e),g=n.root,m=[],y=[];function b(t,e,n,r){var o={name:""};o="string"==typeof t?{name:t}:t;var i=y.filter((function(t){return t.name===o.name}));if(i.length>0){var s=i[0];if(s.type!==e)throw new Error("A metric named "+o.name+" is already defined with different type.");return void 0!==n&&s.update(n),s}var a=r(o);return y.push(a),a}var w={get name(){return u},get description(){return d},get repo(){return p},get parent(){return l},path:h,id:v,root:g,get subSystems(){return m},get metrics(){return y},subSystem:function(e,n){if(!e||0===e.length)throw new Error("name is required");var r=m.filter((function(t){return t.name===e}));if(r.length>0)return r[0];var o=t(e,p,c,w,n);return m.push(o),o},getState:function(){return f},setState:function(t,e){f={state:t,description:e},c.updateSystem(w,f)},stringMetric:function(t,e){return b(t,se,e,(function(t){return new we(t,w,c,e)}))},timestampMetric:function(t,e){return b(t,ce,e,(function(t){return new Se(t,w,c,e)}))},objectMetric:function(t,e){return b(t,ue,e,(function(t){return new be(t,w,c,e)}))},numberMetric:function(t,e){return b(t,ae,e,(function(t){return new ye(t,w,c,e)}))},getAggregateState:function(){var t=[];return Object.keys(f).length>0&&t.push({name:u,path:h,state:f.state,description:f.description}),m.forEach((function(e){var n=e.getAggregateState();n.length>0&&t.push.apply(t,n)})),t}};return c.createSystem(w),w}("",this,e),this.addSystemMetrics(this.root,t.clickStream||void 0===t.clickStream)}return t.prototype.addSystemMetrics=function(t,e){if("undefined"!=typeof navigator&&t.stringMetric("UserAgent",navigator.userAgent),e&&"undefined"!=typeof document){var n=t.subSystem("ClickStream"),r=function(t){if(t.target){var e=t.target;n.objectMetric("LastBrowserEvent",{type:"click",timestamp:new Date,target:{className:t.target?e.className:"",id:e.id,type:"<"+e.tagName.toLowerCase()+">",href:e.href||""}})}};n.objectMetric("Page",{title:document.title,page:window.location.href}),document.addEventListener?document.addEventListener("click",r):document.attachEvent("onclick",r)}t.stringMetric("StartTime",(new Date).toString());var o=t.stringMetric("StartURL",""),i=t.stringMetric("AppName","");if("undefined"!=typeof window){if(void 0!==window.location){var s=window.location.href;o.update(s)}void 0!==window.glue42gd&&i.update(window.glue42gd.appName)}},t}(),_e=function(){function t(){}return t.prototype.init=function(t){},t.prototype.createSystem=function(t){},t.prototype.updateSystem=function(t,e){},t.prototype.createMetric=function(t){},t.prototype.updateMetric=function(t){},t}(),ke=function(t){var e;return e=t.connection&&"object"==typeof t.connection?function(t,e){if(!t||"object"!=typeof t)throw new Error("Connection is required parameter");var n,r,o=function(t){i(t.root)},i=function(t){s(t),t.metrics.forEach((function(t){a(t)})),t.subSystems.forEach((function(t){i(t)}))},s=function(t){void 0!==t.parent&&n.then((function(){var e={type:"define",metrics:[{name:he(t.path.join("/")+"/"+t.name+"/State"),type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};r.send(e)}))},a=function(t){var e=u(t);n.then((function(){var t={type:"define",metrics:[le(e)]};r.send(t),void 0!==e.value&&c(e)}))},c=function(t){if(d()){var e=fe(t),n={type:"publish",values:[{name:he(t.path.join("/")+"/"+t.name),value:e,timestamp:Date.now()}]};r.send(n)}},u=function(t){var e=ne({},t);return"object"==typeof t.value&&null!==t.value&&(e.value=ne({},t.value)),e},d=function(){var t;try{return(null!==(t=e.canUpdateMetric)&&void 0!==t?t:function(){return!0})()}catch(t){return!0}};return{init:function(i){var s;n=new Promise((function(t){s=t})),(r=t.domain("metrics")).onJoined((function(t){!t&&s&&(s(),s=void 0);var e={type:"define",metrics:[{name:"/State",type:"object",composite:{Description:{type:"string",description:""},Value:{type:"number",description:""}},description:"System state",context:{}}]};r.send(e),t&&o(i)})),r.join({system:e.system,service:e.service,instance:e.instance})},createSystem:s,updateSystem:function(e,o){n.then((function(){var n={type:"publish",values:[{name:he(e.path.join("/")+"/"+e.name+"/State"),value:{Description:o.description,Value:o.state},timestamp:Date.now()}]};r.send(n);var i=ve(e),s={type:"publish",peer_id:t.peerId,values:[{name:"/State",value:{Description:i.description,Value:i.value},timestamp:Date.now()}]};r.send(s)}))},createMetric:a,updateMetric:function(t){var e=u(t);n.then((function(){return c(e)}))}}}(t.connection,t):new _e,new xe(t,e).root};function Ie(t){if(t&&t.errorHandling&&"function"!=typeof t.errorHandling&&"log"!==t.errorHandling&&"silent"!==t.errorHandling&&"throw"!==t.errorHandling)throw new Error('Invalid options passed to createRegistry. Prop errorHandling should be ["log" | "silent" | "throw" | (err) => void], but '+typeof t.errorHandling+" was passed");var e=t&&"function"==typeof t.errorHandling&&t.errorHandling,n={};function r(n,r){var o=n instanceof Error?n:new Error(n);if(e)e(o);else{var i='[ERROR] callback-registry: User callback for key "'+r+'" failed: '+o.stack;if(t)switch(t.errorHandling){case"log":return console.error(i);case"silent":return;case"throw":throw new Error(i)}console.error(i)}}return{add:function(t,e){var r=n[t];return r||(r=[],n[t]=r),r.push(e),function(){var r=n[t];r&&(r=r.reduce((function(t,n,r){return n===e&&t.length===r||t.push(n),t}),[]),n[t]=r)}},execute:function(t){for(var e=[],o=1;o<arguments.length;o++)e[o-1]=arguments[o];var i=n[t];if(!i||0===i.length)return[];var s=[];return i.forEach((function(n){try{var o=n.apply(void 0,e);s.push(o)}catch(e){s.push(void 0),r(e,t)}})),s},clear:function(){n={}},clearKey:function(t){n[t]&&delete n[t]}}}Ie.default=Ie;var je=Ie,Te=function(){function t(t,e){var n=this;this.registry=je(),this.gw=t.facade,this.gw.connect((function(t,e){n.messageHandler(e)})).then((function(t){n.client=t}))}return Object.defineProperty(t.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.sendObject=function(t){return this.client?(this.client.send(t),Promise.resolve(void 0)):Promise.reject("not connected")},t.prototype.send=function(t){return Promise.reject("not supported")},t.prototype.onMessage=function(t){return this.registry.add("onMessage",t)},t.prototype.onConnectedChanged=function(t){t(!0)},t.prototype.close=function(){return Promise.resolve()},t.prototype.open=function(){return Promise.resolve()},t.prototype.name=function(){return"in-memory"},t.prototype.reconnect=function(){return Promise.resolve()},t.prototype.messageHandler=function(t){this.registry.execute("onMessage",t)},t}(),Me=function(){function t(t,e){var n=this;this.logger=e,this.registry=je(),this.worker=new SharedWorker(t),this.worker.port.onmessage=function(t){n.messageHandler(t.data)}}return Object.defineProperty(t.prototype,"isObjectBasedTransport",{get:function(){return!0},enumerable:!0,configurable:!0}),t.prototype.sendObject=function(t){return this.worker.port.postMessage(t),Promise.resolve()},t.prototype.send=function(t){return Promise.reject("not supported")},t.prototype.onMessage=function(t){return this.registry.add("onMessage",t)},t.prototype.onConnectedChanged=function(t){t(!0)},t.prototype.close=function(){return Promise.resolve()},t.prototype.open=function(){return Promise.resolve()},t.prototype.name=function(){return"shared-worker"},t.prototype.reconnect=function(){return Promise.resolve()},t.prototype.messageHandler=function(t){this.registry.execute("onMessage",t)},t}(),Ce=function(){function t(){}return t.getGDMajorVersion=function(){if("undefined"!=typeof window&&window.glueDesktop&&window.glueDesktop.version){var t=Number(window.glueDesktop.version.substr(0,1));return isNaN(t)?void 0:t}},t.isNode=function(){if(void 0!==t._isNode)return t._isNode;if("undefined"!=typeof window)return t._isNode=!1,!1;try{t._isNode="[object process]"===Object.prototype.toString.call(global.process)}catch(e){t._isNode=!1}return t._isNode},t}(),Oe=function(){function t(){var t=this;this.rejected=!1,this.resolved=!1,this.promise=new Promise((function(e,n){t.resolve=function(n){t.resolved=!0,e(n)},t.reject=function(e){t.rejected=!0,n(e)}}))}return t.delay=function(t){return new Promise((function(e){return setTimeout(e,t)}))},Object.defineProperty(t.prototype,"ended",{get:function(){return this.rejected||this.resolved},enumerable:!0,configurable:!0}),t}(),Ee=Ce.isNode()?require("ws"):window.WebSocket,Pe=function(){function t(t,e){if(this._running=!0,this._registry=je(),this.wsRequests=[],this.settings=t,this.logger=e,!this.settings.ws)throw new Error("ws is missing")}return t.prototype.onMessage=function(t){return this._registry.add("onMessage",t)},t.prototype.send=function(t,e){var n=this;return new Promise((function(e,r){n.waitForSocketConnection((function(){var o;try{null===(o=n.ws)||void 0===o||o.send(t),e()}catch(t){r(t)}}),r)}))},t.prototype.open=function(){var t=this;return this.logger.info("opening ws..."),this._running=!0,new Promise((function(e,n){t.waitForSocketConnection(e,n)}))},t.prototype.close=function(){return this._running=!1,this.ws&&this.ws.close(),Promise.resolve()},t.prototype.onConnectedChanged=function(t){return this._registry.add("onConnectedChanged",t)},t.prototype.name=function(){return"ws "+this.settings.ws},t.prototype.reconnect=function(){var t;null===(t=this.ws)||void 0===t||t.close();var e=new Oe;return this.waitForSocketConnection((function(){e.resolve()})),e.promise},t.prototype.waitForSocketConnection=function(t,e){var n;e=null!=e?e:function(){},this._running?1!==(null===(n=this.ws)||void 0===n?void 0:n.readyState)?(this.wsRequests.push({callback:t,failed:e}),this.wsRequests.length>1||this.openSocket()):t():e("wait for socket on "+this.settings.ws+" failed - socket closed by user")},t.prototype.openSocket=function(t,e){return re(this,void 0,void 0,(function(){var n=this;return oe(this,(function(r){switch(r.label){case 0:if(void 0===t&&(t=this.settings.reconnectInterval),void 0!==e){if(0===e)return this.notifyForSocketState("wait for socket on "+this.settings.ws+" failed - no more retries left"),[2];this.logger.debug("will retry "+e+" more times (every "+t+" ms)")}r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.initiateSocket()];case 2:return r.sent(),this.notifyForSocketState(),[3,4];case 3:return r.sent(),setTimeout((function(){var r=void 0===e?void 0:e-1;n.openSocket(t,r)}),t),[3,4];case 4:return[2]}}))}))},t.prototype.initiateSocket=function(){var t=this,e=new Oe;return this.logger.debug("initiating ws to "+this.settings.ws+"..."),this.ws=new Ee(this.settings.ws||""),this.ws.onerror=function(n){var r="";try{r=JSON.stringify(n)}catch(t){var o=new WeakSet;r=JSON.stringify(n,(function(t,e){if("object"==typeof e&&null!==e){if(o.has(e))return;o.add(e)}return e}))}e.reject("error"),t.notifyStatusChanged(!1,r)},this.ws.onclose=function(n){t.logger.info("ws closed "+n),e.reject("closed"),t.notifyStatusChanged(!1)},this.ws.onopen=function(){var n;t.logger.info("ws opened "+(null===(n=t.settings.identity)||void 0===n?void 0:n.application)),e.resolve(),t.notifyStatusChanged(!0)},this.ws.onmessage=function(e){t._registry.execute("onMessage",e.data)},e.promise},t.prototype.notifyForSocketState=function(t){this.wsRequests.forEach((function(e){t?e.failed&&e.failed(t):e.callback()})),this.wsRequests=[]},t.prototype.notifyStatusChanged=function(t,e){this._registry.execute("onConnectedChanged",t,e)},t}();var Ae=1;var Le,Re,Ne,De={nextValue:function(){return(Ae=(9301*Ae+49297)%233280)/233280},seed:function(t){Ae=t}},qe="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function Fe(){Ne=!1}function We(t){if(t){if(t!==Le){if(t.length!==qe.length)throw new Error("Custom alphabet for shortid must be "+qe.length+" unique characters. You submitted "+t.length+" characters: "+t);var e=t.split("").filter((function(t,e,n){return e!==n.lastIndexOf(t)}));if(e.length)throw new Error("Custom alphabet for shortid must be "+qe.length+" unique characters. These characters were not unique: "+e.join(", "));Le=t,Fe()}}else Le!==qe&&(Le=qe,Fe())}function Be(){return Ne||(Ne=function(){Le||We(qe);for(var t,e=Le.split(""),n=[],r=De.nextValue();e.length>0;)r=De.nextValue(),t=Math.floor(r*e.length),n.push(e.splice(t,1)[0]);return n.join("")}())}var Ue={characters:function(t){return We(t),Le},seed:function(t){De.seed(t),Re!==t&&(Fe(),Re=t)},lookup:function(t){return Be()[t]},shuffled:Be},He="object"==typeof window&&(window.crypto||window.msCrypto);var Ke=function(){if(!He||!He.getRandomValues)return 48&Math.floor(256*Math.random());var t=new Uint8Array(1);return He.getRandomValues(t),48&t[0]};var Je=function(t,e){for(var n,r=0,o="";!n;)o+=t(e>>4*r&15|Ke()),n=e<Math.pow(16,r+1),r++;return o};var Ge=function(t){var e=Ue.shuffled();return{version:15&e.indexOf(t.substr(0,1)),worker:15&e.indexOf(t.substr(1,1))}};var Ve=function(t){if(!t||"string"!=typeof t||t.length<6)return!1;for(var e=Ue.characters(),n=t.length,r=0;r<n;r++)if(-1===e.indexOf(t[r]))return!1;return!0},ze=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t){var e,n,r=0;function o(){var t="",o=Math.floor(.001*(Date.now()-1459707606518));return o===n?e++:(e=0,n=o),t+=Je(Ue.lookup,6),t+=Je(Ue.lookup,r),e>0&&(t+=Je(Ue.lookup,e)),t+=Je(Ue.lookup,o)}t.exports=o,t.exports.generate=o,t.exports.seed=function(e){return Ue.seed(e),t.exports},t.exports.worker=function(e){return r=e,t.exports},t.exports.characters=function(t){return void 0!==t&&Ue.characters(t),Ue.shuffled()},t.exports.decode=Ge,t.exports.isValid=Ve})),Ye=(ze.generate,ze.seed,ze.worker,ze.characters,ze.decode,ze.isValid,ze);function Xe(t,e,n,r,o){null==t&&(t="global"),r=r||["success"],o=o||["error"];var i,s=!1,a=!1,c=!1,u=je();e.disconnected((function(){c=!1,n.debug("connection is down"),s=!1,a=!0,u.execute("onLeft",{disconnected:!0})})),e.loggedIn((function(){c=!0,a&&(n.debug("connection is now up - trying to reconnect..."),p(i))})),e.on("success",(function(t){return h(t)})),e.on("error",(function(t){return l(t)})),e.on("result",(function(t){return h(t)})),r&&r.forEach((function(t){e.on(t,(function(t){return h(t)}))})),o&&o.forEach((function(t){e.on(t,(function(t){return l(t)}))}));var d={};function p(e){return i=e,new Promise((function(r,o){if(s)r();else{var i;if("global"===t)i=c?Promise.resolve({}):Promise.reject("not connected to gateway");else n.debug("joining domain "+t),i=v({type:"join",destination:t,domain:"global",options:e});i.then((function(){!function(){n.debug("did join "+t),s=!0;var e=a;a=!1,u.execute("onJoined",e)}(),r()})).catch((function(e){n.debug("error joining "+t+" domain: "+JSON.stringify(e)),o(e)}))}}))}function l(e){if(t===e.domain){var n=e.request_id;if(n){var r=d[n];r&&r.error(e)}}}function h(e){if(e.domain===t){var n=e.request_id;if(n){var r=d[n];r&&r.success(e)}}}function f(){return Ye()}function v(r,o,i){i=i||{},r.request_id=r.request_id||f(),r.domain=r.domain||t,i.skipPeerId||(r.peer_id=e.peerId);var s=r.request_id;return new Promise((function(t,a){d[s]={success:function(e){delete d[s],e._tag=o,t(e)},error:function(t){n.warn("GW error - "+JSON.stringify(t)+" for request "+JSON.stringify(r)),delete d[s],t._tag=o,a(t)}},e.send(r,i).catch((function(t){d[s].error({err:t})}))}))}return{join:p,leave:function(){return"global"===t?Promise.resolve():(n.debug("stopping session "+t+"..."),a=!1,v({type:"leave",destination:t,domain:"global"}).then((function(){s=!1,u.execute("onLeft")})))},onJoined:function(t){return s&&t(!1),u.add("onJoined",t)},onLeft:function(t){return s||t(),u.add("onLeft",t)},send:v,sendFireAndForget:function(n){n.request_id=n.request_id?n.request_id:f(),n.domain=n.domain||t,n.peer_id=e.peerId,e.send(n)},on:function(r,o){e.on(r,(function(e){if(e.domain===t)try{o(e)}catch(t){n.error("Callback  failed: "+t+" \n "+t.stack+" \n msg was: "+JSON.stringify(e),t)}}))},loggedIn:function(t){return e.loggedIn(t)},connected:function(t){return e.connected(t)},disconnected:function(t){return e.disconnected(t)},get peerId(){return e.peerId},get domain(){return t}}}var $e=function(){function t(t,e,n){var r=this;this.connection=t,this.settings=e,this.logger=n,this.protocolVersion=3,this.datePrefix="#T42_DATE#",this.datePrefixLen=this.datePrefix.length,this.dateMinLen=this.datePrefixLen+1,this.datePrefixFirstChar=this.datePrefix[0],this.registry=je(),this._isLoggedIn=!1,this.shouldTryLogin=!0,this.initialLogin=!0,this.initialLoginAttempts=3,this.sessions=[],t.disconnected((function(){r.handleDisconnected()})),this.ping()}return Object.defineProperty(t.prototype,"isLoggedIn",{get:function(){return this._isLoggedIn},enumerable:!0,configurable:!0}),t.prototype.processStringMessage=function(t){var e=this,n=JSON.parse(t,(function(t,n){if("string"!=typeof n)return n;if(n.length<e.dateMinLen)return n;if(n[0]!==e.datePrefixFirstChar)return n;if(n.substring(0,e.datePrefixLen)!==e.datePrefix)return n;try{var r=parseInt(n.substring(e.datePrefixLen,n.length),10);return isNaN(r)?n:new Date(r)}catch(t){return n}}));return{msg:n,msgType:n.type}},t.prototype.createStringMessage=function(t){var e=Date.prototype.toJSON;try{var n=this.datePrefix;return Date.prototype.toJSON=function(){return n+this.getTime()},JSON.stringify(t)}finally{Date.prototype.toJSON=e}},t.prototype.processObjectMessage=function(t){if(!t.type)throw new Error("Object should have type property");return{msg:t,msgType:t.type}},t.prototype.createObjectMessage=function(t){return t},t.prototype.login=function(t,e){return re(this,void 0,void 0,(function(){var n,r,o,i,s,a,c,u,d,p;return oe(this,(function(l){switch(l.label){case 0:if(this.logger.debug("logging in..."),this.loginConfig=t,this.loginConfig||(this.loginConfig={username:"",password:""}),this.shouldTryLogin=!0,n={},this.connection.gatewayToken=t.gatewayToken,!t.gatewayToken)return[3,5];if(!e)return[3,4];l.label=1;case 1:return l.trys.push([1,3,,4]),[4,this.getNewGWToken()];case 2:return u=l.sent(),t.gatewayToken=u,[3,4];case 3:return r=l.sent(),this.logger.warn("failed to get GW token when reconnecting "+((null==r?void 0:r.message)||r)),[3,4];case 4:return n.method="gateway-token",n.token=t.gatewayToken,this.connection.gatewayToken=t.gatewayToken,[3,10];case 5:return"sspi"!==t.flowName?[3,9]:(n.provider="win",n.method="access-token",t.flowCallback&&t.sessionId?(o=n,[4,t.flowCallback(t.sessionId,null)]):[3,7]);case 6:return o.token=l.sent().data.toString("base64"),[3,8];case 7:throw new Error("Invalid SSPI config");case 8:return[3,10];case 9:if(t.token)n.method="access-token",n.token=t.token;else{if(!t.username)throw new Error("invalid auth message"+JSON.stringify(t));n.method="secret",n.login=t.username,n.secret=t.password}l.label=10;case 10:i={type:"hello",identity:this.settings.identity,authentication:n},t.sessionId&&(i.request_id=t.sessionId),this.globalDomain=Xe("global",this.connection,this.logger.subLogger("global-domain"),["welcome","token","authentication-request"]),s={skipPeerId:!0},this.initialLogin&&(s.retryInterval=this.settings.reconnectInterval,s.maxRetries=this.settings.reconnectAttempts),l.label=11;case 11:l.trys.push([11,19,20,21]),a=void 0,l.label=12;case 12:return[4,this.globalDomain.send(i,void 0,s)];case 13:return"authentication-request"!==(c=l.sent()).type?[3,16]:(u=Buffer.from(c.authentication.token,"base64"),t.flowCallback&&t.sessionId?(d=i.authentication,[4,t.flowCallback(t.sessionId,u)]):[3,15]);case 14:d.token=l.sent().data.toString("base64"),l.label=15;case 15:return i.request_id=t.sessionId,[3,12];case 16:if("welcome"===c.type)return a=c,[3,18];throw"error"===c.type?new Error("Authentication failed: "+c.reason):new Error("Unexpected message type during authentication: "+c.type);case 17:return[3,12];case 18:return this.initialLogin=!1,this.logger.info("login successful with peerId "+a.peer_id),this.connection.peerId=a.peer_id,this.connection.resolvedIdentity=a.resolved_identity,this.connection.availableDomains=a.available_domains,a.options&&(this.connection.token=a.options.access_token,this.connection.info=a.options.info),this.setLoggedIn(!0),[2,a.resolved_identity];case 19:throw p=l.sent(),this.logger.error("error sending hello message - "+(p.message||p.msg||p.reason||p),p),p;case 20:return t&&t.flowCallback&&t.sessionId&&t.flowCallback(t.sessionId,null),[7];case 21:return[2]}}))}))},t.prototype.logout=function(){return re(this,void 0,void 0,(function(){var t;return oe(this,(function(e){switch(e.label){case 0:return this.logger.debug("logging out..."),this.shouldTryLogin=!1,this.pingTimer&&clearTimeout(this.pingTimer),t=this.sessions.map((function(t){t.leave()})),[4,Promise.all(t)];case 1:return e.sent(),[2]}}))}))},t.prototype.loggedIn=function(t){return this._isLoggedIn&&t(),this.registry.add("onLoggedIn",t)},t.prototype.domain=function(t,e,n,r){var o=this.sessions.filter((function(e){return e.domain===t}))[0];return o||(o=Xe(t,this.connection,e,n,r),this.sessions.push(o)),o},t.prototype.handleDisconnected=function(){var t=this;if(this.setLoggedIn(!1),this.shouldTryLogin&&this.initialLogin){if(this.initialLoginAttempts<=0)return;this.initialLoginAttempts--}if(this.logger.debug("disconnected - will try new login?"+this.shouldTryLogin),this.shouldTryLogin){if(!this.loginConfig)throw new Error("no login info");this.connection.login(this.loginConfig,!0).catch((function(){setTimeout(t.handleDisconnected,1e3)}))}},t.prototype.setLoggedIn=function(t){this._isLoggedIn=t,this._isLoggedIn&&this.registry.execute("onLoggedIn")},t.prototype.ping=function(){var t=this;this.shouldTryLogin&&(this._isLoggedIn&&this.connection.send({type:"ping"}),this.pingTimer=setTimeout((function(){t.ping()}),3e4))},t.prototype.authToken=function(){return this.globalDomain?this.globalDomain.send({type:"create-token"}).then((function(t){return t.token})):Promise.reject(new Error("no global domain session"))},t.prototype.getNewGWToken=function(){if(void 0!==typeof window){var t=window.glue42gd;if(t)return t.getGWToken()}return Promise.reject(new Error("not running in GD"))},t}(),Qe=function(){function t(t){this.specsNames=[],this.messages={},this.subs={},this.subsRefCount={},this.specs={};for(var e=0,n=t;e<n.length;e++){var r=n[e];this.specs[r.name]=r,this.specsNames.push(r.name)}}return t.prototype.init=function(t){var e=this;this.connection=t;for(var n=0,r=this.specsNames;n<r.length;n++)for(var o=r[n],i=function(n){var r=s.subsRefCount[n];if(r||(r=0),r+=1,s.subsRefCount[n]=r,r>1)return"continue";var o=t.on(n,(function(t){return e.processMessage(n,t)}));s.subs[n]=o},s=this,a=0,c=this.specs[o].types;a<c.length;a++){i(c[a])}},t.prototype.processMessage=function(t,e){if(!this.isDone&&e)for(var n=0,r=this.specsNames;n<r.length;n++){var o=r[n];if(-1!==this.specs[o].types.indexOf(t)){var i=this.messages[o]||[];this.messages[o]=i,i.push(e)}}},t.prototype.drain=function(t,e){var n;e&&(this.messages[t]||[]).forEach(e),delete this.messages[t];for(var r=0,o=this.specs[t].types;r<o.length;r++){var i=o[r];this.subsRefCount[i]-=1,this.subsRefCount[i]<=0&&(null===(n=this.connection)||void 0===n||n.off(this.subs[i]),delete this.subs[i],delete this.subsRefCount[i])}delete this.specs[t],this.specs.length||(this.isDone=!0)},t}(),Ze=function(){function t(t,e){if(this.settings=t,this.logger=e,this.messageHandlers={},this.ids=1,this.registry=je(),this._connected=!1,this.isTrace=!1,(t=t||{}).reconnectAttempts=t.reconnectAttempts||10,t.reconnectInterval=t.reconnectInterval||1e3,t.inproc)this.transport=new Te(t.inproc,e.subLogger("inMemory"));else if(t.sharedWorker)this.transport=new Me(t.sharedWorker,e.subLogger("shared-worker"));else{if(void 0===t.ws)throw new Error("No connection information specified");this.transport=new Pe(t,e.subLogger("ws"))}this.isTrace=e.canPublish("trace"),e.info("starting with "+this.transport.name()+" transport"),this.protocol=new $e(this,t,e.subLogger("protocol")),this.transport.onConnectedChanged(this.handleConnectionChanged.bind(this)),this.transport.onMessage(this.handleTransportMessage.bind(this)),t.replaySpecs&&t.replaySpecs.length&&(this.replayer=new Qe(t.replaySpecs),this.replayer.init(this))}return Object.defineProperty(t.prototype,"protocolVersion",{get:function(){var t;return null===(t=this.protocol)||void 0===t?void 0:t.protocolVersion},enumerable:!0,configurable:!0}),t.prototype.send=function(t,e){if(this.transport.sendObject&&this.transport.isObjectBasedTransport){var n=this.protocol.createObjectMessage(t);return this.isTrace&&this.logger.trace(">> "+JSON.stringify(n)),this.transport.sendObject(n,e)}var r=this.protocol.createStringMessage(t);return this.isTrace&&this.logger.trace(">> "+r),this.transport.send(r,e)},t.prototype.on=function(t,e){t=t.toLowerCase(),void 0===this.messageHandlers[t]&&(this.messageHandlers[t]={});var n=this.ids++;return this.messageHandlers[t][n]=e,{type:t,id:n}},t.prototype.off=function(t){delete this.messageHandlers[t.type.toLowerCase()][t.id]},Object.defineProperty(t.prototype,"isConnected",{get:function(){return this.protocol.isLoggedIn},enumerable:!0,configurable:!0}),t.prototype.connected=function(t){var e=this;return this.protocol.loggedIn((function(){t(e.settings.ws||e.settings.sharedWorker||"")}))},t.prototype.disconnected=function(t){return this.registry.add("disconnected",t)},t.prototype.login=function(t,e){return re(this,void 0,void 0,(function(){return oe(this,(function(n){switch(n.label){case 0:return[4,this.transport.open()];case 1:return n.sent(),[2,this.protocol.login(t,e)]}}))}))},t.prototype.logout=function(){return re(this,void 0,void 0,(function(){return oe(this,(function(t){switch(t.label){case 0:return[4,this.protocol.logout()];case 1:return t.sent(),[4,this.transport.close()];case 2:return t.sent(),[2]}}))}))},t.prototype.loggedIn=function(t){return this.protocol.loggedIn(t)},t.prototype.domain=function(t,e,n){return this.protocol.domain(t,this.logger.subLogger("domain="+t),e,n)},t.prototype.authToken=function(){return this.protocol.authToken()},t.prototype.reconnect=function(){return this.transport.reconnect()},t.prototype.distributeMessage=function(t,e){var n=this,r=this.messageHandlers[e.toLowerCase()];void 0!==r&&Object.keys(r).forEach((function(e){var o=r[e];if(void 0!==o)try{o(t)}catch(t){n.logger.error("Message handler failed with "+t.stack,t)}}))},t.prototype.handleConnectionChanged=function(t){this._connected!==t&&(this._connected=t,t?this.registry.execute("connected"):this.registry.execute("disconnected"))},t.prototype.handleTransportMessage=function(t){var e;e="string"==typeof t?this.protocol.processStringMessage(t):this.protocol.processObjectMessage(t),this.isTrace&&this.logger.trace("<< "+JSON.stringify(e)),this.distributeMessage(e.msg,e.msgType)},t}(),tn=["trace","debug","info","warn","error","off"],en=function(){function t(t,e,n){this.name=t,this.parent=e,this.subLoggers=[],this.logFn=console,this.customLogFn=!1,this.name=t,this.path=e?e.path+"."+t:t,this.loggerFullName="["+this.path+"]",this.includeTimeAndLevel=!n,n&&(this.logFn=n,this.customLogFn=!0)}return t.prototype.subLogger=function(e){var n=this.subLoggers.filter((function(t){return t.name===e}))[0];if(void 0!==n)return n;Object.keys(this).forEach((function(t){if(t===e)throw new Error("This sub logger name is not allowed.")}));var r=new t(e,this,this.customLogFn?this.logFn:void 0);return this.subLoggers.push(r),r},t.prototype.publishLevel=function(t){var e;return t&&(this._publishLevel=t),this._publishLevel||(null===(e=this.parent)||void 0===e?void 0:e.publishLevel())},t.prototype.consoleLevel=function(t){var e;return t&&(this._consoleLevel=t),this._consoleLevel||(null===(e=this.parent)||void 0===e?void 0:e.consoleLevel())},t.prototype.log=function(t,e,n){this.publishMessage(e||"info",t,n)},t.prototype.trace=function(t){this.log(t,"trace")},t.prototype.debug=function(t){this.log(t,"debug")},t.prototype.info=function(t){this.log(t,"info")},t.prototype.warn=function(t){this.log(t,"warn")},t.prototype.error=function(t,e){this.log(t,"error")},t.prototype.canPublish=function(t,e){return tn.indexOf(t)>=tn.indexOf(e||this.consoleLevel()||"trace")},t.prototype.publishMessage=function(e,n,r){var o,i,s=this.loggerFullName;if("error"===e&&!r){var a=new Error;a.stack&&(n=n+"\n"+a.stack.split("\n").slice(3).join("\n"))}if(this.canPublish(e,this.publishLevel())&&(null===(o=t.Interop)||void 0===o?void 0:o.methods({name:t.InteropMethodName}).length)>0&&(null===(i=t.Interop)||void 0===i||i.invoke(t.InteropMethodName,{msg:""+n,logger:s,level:e})),this.canPublish(e)){var c="";if(this.includeTimeAndLevel){var u=new Date;c="["+(u.getHours()+":"+u.getMinutes()+":"+u.getSeconds()+":"+u.getMilliseconds())+"] ["+e+"] "}var d=""+c+s+": "+n;switch(e){case"trace":this.logFn.debug(d);break;case"debug":this.logFn.debug?this.logFn.debug(d):this.logFn.log(d);break;case"info":this.logFn.info(d);break;case"warn":this.logFn.warn(d);break;case"error":this.logFn.error(d,r)}}},t.InteropMethodName="T42.AppLogger.Log",t}(),nn={get name(){return"context"},get types(){return["create-context","created","destroyed","context-created","context-added","subscribe-context","subscribed-context","unsubscribe-context","destroy-context","context-destroyed","update-context","context-updated","joined"]}};function rn(t,e,n){var r,o,i,s,a;if(Ce.isNode()){var c=process.env._GD_STARTING_CONTEXT_;if(c)try{a=JSON.parse(c)}catch(t){}}var u=function(){var r,o,i,s,c,u,d,p,l,h=t.gateway,f=null!==(r=null==h?void 0:h.protocolVersion)&&void 0!==r?r:3,v=null==h?void 0:h.reconnectInterval,g=null==h?void 0:h.reconnectAttempts,m=null==h?void 0:h.ws,y=null==h?void 0:h.sharedWorker,b=null==h?void 0:h.inproc;n&&(m=n.gwURL),Ce.isNode()&&a&&a.gwURL&&(m=a.gwURL),m||y||b||(m="ws://localhost:8385");var w=function(){if(t.application)return t.application;if(n)return n.applicationName;var e=Ye();if(Ce.isNode())return a?a.applicationConfig.name:"NodeJS"+e;if("undefined"!=typeof window&&"undefined"!=typeof document)return document.title+" ("+e+")";return e}(),S=w;void 0!==n?(u=n.windowId,d=n.pid,n.env&&(p=n.env.env,l=n.env.region),S=null!==(o=n.application)&&void 0!==o?o:"glue-app",c=n.appInstanceId):Ce.isNode()?(d=process.pid,a&&(p=a.env,l=a.region,c=a.instanceId)):u=window.name||Ye();var x=null!==(s=null===(i=t.gateway)||void 0===i?void 0:i.replaySpecs)&&void 0!==s?s:[];return x.push(nn),{identity:{application:S,applicationName:w,windowId:u,instance:c,process:d,region:l,environment:p,api:e.version||"5.0.7"},reconnectInterval:v,ws:m,sharedWorker:y,inproc:b,protocolVersion:f,reconnectAttempts:g,replaySpecs:x}}();return{bus:null!==(r=t.bus)&&void 0!==r&&r,auth:function(){var e,n;return"string"==typeof t.auth?{token:t.auth}:t.auth?t.auth:Ce.isNode()&&a&&a.gwToken?{gatewayToken:a.gwToken}:(null===(e=t.gateway)||void 0===e?void 0:e.inproc)||(null===(n=t.gateway)||void 0===n?void 0:n.sharedWorker)?{username:"glue42",password:"glue42"}:void 0}(),logger:function(){var e,n,r=t.logger;return r||(r="error"),"string"==typeof r?{console:r,publish:"error"}:{console:null!==(e=r.console)&&void 0!==e?e:"error",publish:null!==(n=r.publish)&&void 0!==n?n:"error"}}(),connection:u,metrics:null===(o=t.metrics)||void 0===o||o,contexts:null===(i=t.contexts)||void 0===i||i,version:e.version||"5.0.7",libs:null!==(s=e.libs)&&void 0!==s?s:[],customLogger:t.customLogger}}function on(){function t(){return(new Date).getTime()}var e,n,r=t();return{get startTime(){return r},get endTime(){return e},get period(){return n},stop:function(){return e=t(),n=t()-r}}}var sn=function(){function t(t,e,n,r){this.updateCallbacks={},this.contextId=t,this.name=e,this.isAnnounced=n,this.activityId=r,this.context={}}return t.prototype.hasCallbacks=function(){return Object.keys(this.updateCallbacks).length>0},t.prototype.getState=function(){return this.isAnnounced&&this.hasCallbacks()?3:this.isAnnounced?2:this.hasCallbacks()?1:0},t}();function an(t,e){if(e){if(e.reset)return t=ne({},e.reset);t=cn(t,void 0);var n=e.added,r=e.updated,o=e.removed;n&&Object.keys(n).forEach((function(e){t[e]=n[e]})),r&&Object.keys(r).forEach((function(e){un(e,t,r)})),o&&o.forEach((function(e){delete t[e]}))}return t}function cn(t,e){if(e=e||new WeakMap,Object(t)!==t)return t;if(t instanceof Set)return new Set(t);if(e.has(t))return e.get(t);var n=t instanceof Date?new Date(t):t instanceof RegExp?new RegExp(t.source,t.flags):t.constructor?new t.constructor:Object.create(null);return e.set(t,n),Object.assign.apply(Object,ie([n],Object.keys(t).map((function(n){var r;return(r={})[n]=cn(t[n],e),r}))))}var un=function(t,e,n){var r=n[t];if(void 0===r)return e;var o=e[t];return o&&r?"string"==typeof o||"number"==typeof o||"boolean"==typeof o||"string"==typeof r||"number"==typeof r||"boolean"==typeof r||Array.isArray(o)||Array.isArray(r)?(e[t]=r,e):(e[t]=Object.assign({},o,r),e):(e[t]=r,e)};function dn(t,e){if(t===e)return!0;if(!(t instanceof Object&&e instanceof Object))return!1;if(t.constructor!==e.constructor)return!1;for(var n in t)if(t.hasOwnProperty(n)){if(!e.hasOwnProperty(n))return!1;if(t[n]!==e[n]){if("object"!=typeof t[n])return!1;if(!dn(t[n],e[n]))return!1}}for(var n in e)if(e.hasOwnProperty(n)&&!t.hasOwnProperty(n))return!1;return!0}var pn,ln=function(){function t(t){var e,n=this;this._contextNameToData={},this._gw3Subscriptions=[],this._nextCallbackSubscriptionNumber=0,this._contextNameToId={},this._contextIdToName={},this._connection=t.connection,this._logger=t.logger,this._gw3Session=this._connection.domain("global",["context-created","subscribed-context","context-destroyed","context-updated"]),this.subscribeToContextCreatedMessages(),this.subscribeToContextUpdatedMessages(),this.subscribeToContextDestroyedMessages(),null===(e=this._connection.replayer)||void 0===e||e.drain(nn.name,(function(t){var e=t.type;e&&("context-created"===e||"context-added"===e||"created"===e?n.handleContextCreatedMessage(t):"subscribed-context"===e||"context-updated"===e||"joined"===e?n.handleContextUpdatedMessage(t):"context-destroyed"!==e&&"destroyed"!==e||n.handleContextDestroyedMessage(t))}))}return t.prototype.dispose=function(){for(var t=0,e=this._gw3Subscriptions;t<e.length;t++){var n=e[t];this._connection.off(n)}for(var r in this._gw3Subscriptions.length=0,this._contextNameToData)this._contextNameToId.hasOwnProperty(r)&&delete this._contextNameToData[r]},t.prototype.createContext=function(t,e){var n=this;return this._gw3Session.send({type:"create-context",domain:"global",name:t,data:e,lifetime:"retained"}).then((function(r){if(n._contextNameToId[t]=r.context_id,!n._contextIdToName[r.context_id]){n._contextIdToName[r.context_id]=t;var o=n._contextNameToData[t]||new sn(r.context_id,t,!0,void 0);return o.isAnnounced=!0,o.name=t,o.contextId=r.context_id,n._contextNameToData[t]=o,o.context=r.data,o.sentExplicitSubscription=!0,o.context&&n.invokeUpdateCallbacks(o,o.context,void 0),n.update(t,e).then((function(){return r.context_id}))}return r.context_id}))},t.prototype.all=function(){var t=this;return Object.keys(this._contextNameToData).filter((function(e){return t._contextNameToData[e].isAnnounced}))},t.prototype.update=function(t,e){return re(this,void 0,void 0,(function(){var n,r,o,i=this;return oe(this,(function(s){switch(s.label){case 0:return(n=this._contextNameToData[t])&&n.isAnnounced?(r=n.context,n.hasCallbacks()?[3,2]:[4,this.get(n.name,!1)]):[2,this.createContext(t,e)];case 1:r=s.sent(),s.label=2;case 2:return o=this.calculateContextDelta(r,e),Object.keys(o.added).length||Object.keys(o.updated).length||o.removed.length?[2,this._gw3Session.send({type:"update-context",domain:"global",context_id:n.contextId,delta:o},{},{skipPeerId:!1}).then((function(t){i.handleUpdated(n,o,{updaterId:t.peer_id})}))]:[2,Promise.resolve()]}}))}))},t.prototype.set=function(t,e){var n=this,r=this._contextNameToData[t];return r&&r.isAnnounced?this._gw3Session.send({type:"update-context",domain:"global",context_id:r.contextId,delta:{reset:e}},{},{skipPeerId:!1}).then((function(t){n.handleUpdated(r,{reset:e,added:{},removed:[],updated:{}},{updaterId:t.peer_id})})):this.createContext(t,e)},t.prototype.get=function(t,e){var n=this;void 0===e&&(e=!0);var r=this._contextNameToData[t];return r&&r.isAnnounced&&r.hasCallbacks()||e?Promise.resolve(r&&r.context):new Promise((function(e,r){return re(n,void 0,void 0,(function(){var n=this;return oe(this,(function(r){return this.subscribe(t,(function(t,r,o,i){n.unsubscribe(i),e(t)})),[2]}))}))}))},t.prototype.subscribe=function(t,e){var n=this._nextCallbackSubscriptionNumber;this._nextCallbackSubscriptionNumber+=1;var r=this._contextNameToData[t];if(!r||!r.isAnnounced)return r=r||new sn(void 0,t,!1,void 0),this._contextNameToData[t]=r,r.updateCallbacks[n]=e,Promise.resolve(n);var o=r.hasCallbacks();return r.updateCallbacks[n]=e,o||r.joinedActivity||r.context&&r.sentExplicitSubscription?(e(r.context,r.context,[],n),Promise.resolve(n)):this.sendSubscribe(r).then((function(){return n}))},t.prototype.unsubscribe=function(t){for(var e=0,n=Object.keys(this._contextNameToData);e<n.length;e++){var r=n[e],o=(this._contextNameToId[r],this._contextNameToData[r]);if(!o)return;var i=o.hasCallbacks();delete o.updateCallbacks[t],o.isAnnounced&&i&&!o.hasCallbacks()&&o.sentExplicitSubscription&&this.sendUnsubscribe(o),o.isAnnounced||o.hasCallbacks()||delete this._contextNameToData[r]}},t.prototype.handleUpdated=function(t,e,n){var r=t.context;t.context=an(t.context,e),this._contextNameToData[t.name]!==t||dn(r,t.context)||this.invokeUpdateCallbacks(t,t.context,e,n)},t.prototype.subscribeToContextCreatedMessages=function(){for(var t=0,e=["context-added","context-created","created"];t<e.length;t++){var n=e[t],r=this._connection.on(n,this.handleContextCreatedMessage.bind(this));this._gw3Subscriptions.push(r)}},t.prototype.handleContextCreatedMessage=function(t){var e=t.type;"created"===e?(this._contextNameToId[t.activity_id]=t.context_id,this._contextIdToName[t.context_id]=t.activity_id):"context-added"===e&&(this._contextNameToId[t.name]=t.context_id,this._contextIdToName[t.context_id]=t.name);var n=this._contextIdToName[t.context_id];if(!n)throw new Error("Received created event for context with unknown name: "+t.context_id);if(!this._contextNameToId[n])throw new Error("Received created event for context with unknown id: "+t.context_id);var r=this._contextNameToData[n];if(r){if(r.isAnnounced)return;if(!r.hasCallbacks())throw new Error("Assertion failure: contextData.hasCallbacks()");r.isAnnounced=!0,r.contextId=t.context_id,r.activityId=t.activity_id,r.sentExplicitSubscription||this.sendSubscribe(r)}else this._contextNameToData[n]=r=new sn(t.context_id,n,!0,t.activity_id)},t.prototype.subscribeToContextUpdatedMessages=function(){for(var t=0,e=["context-updated","subscribed-context","joined"];t<e.length;t++){var n=e[t],r=this._connection.on(n,this.handleContextUpdatedMessage.bind(this));this._gw3Subscriptions.push(r)}},t.prototype.handleContextUpdatedMessage=function(t){var e=t.type,n=t.context_id,r=this._contextNameToData[this._contextIdToName[n]],o=!r||!r.isAnnounced;if("joined"===e)r?(r.contextId=n,r.isAnnounced=!0,r.activityId=t.activity_id):(r=new sn(n,t.activity_id,!0,t.activity_id),this._contextNameToData[t.activity_id]=r,this._contextIdToName[n]=t.activity_id,this._contextNameToId[t.activity_id]=n),r.joinedActivity=!0;else if(!r||!r.isAnnounced)return void("subscribed-context"===e?((r=r||new sn(n,t.name,!0,void 0)).sentExplicitSubscription=!0,this._contextNameToData[t.name]=r,this._contextIdToName[n]=t.name,this._contextNameToId[t.name]=n):this._logger.error("Received 'update' for unknown context: "+n));var i=r.context;if("subscribed-context"===e)r.context=t.data||{};else if("joined"===e)r.context=t.context_snapshot||{};else{if("context-updated"!==e)throw new Error("Unrecognized context update message "+e);r.context=an(r.context,t.delta)}!o&&dn(r.context,i)&&"subscribed-context"!==e||this.invokeUpdateCallbacks(r,r.context,t.delta,{updaterId:t.updater_id})},t.prototype.invokeUpdateCallbacks=function(t,e,n,r){for(var o in n=n||{added:{},updated:{},reset:{},removed:[]},t.updateCallbacks)if(t.updateCallbacks.hasOwnProperty(o))try{(0,t.updateCallbacks[o])(cn(e),Object.assign({},n.added||{},n.updated||{},n.reset||{}),n.removed,parseInt(o,10),r)}catch(t){this._logger.debug("callback error: "+JSON.stringify(t))}},t.prototype.subscribeToContextDestroyedMessages=function(){for(var t=0,e=["context-destroyed","destroyed"];t<e.length;t++){var n=e[t],r=this._connection.on(n,this.handleContextDestroyedMessage.bind(this));this._gw3Subscriptions.push(r)}},t.prototype.handleContextDestroyedMessage=function(t){var e,n;if("destroyed"===t.type){if(n=t.activity_id,!(e=this._contextNameToId[n]))return void this._logger.error("Received 'destroyed' for unknown activity: "+t.activity_id)}else if(e=t.context_id,!(n=this._contextIdToName[e]))return void this._logger.error("Received 'destroyed' for unknown context: "+t.context_id);delete this._contextIdToName[e],delete this._contextNameToId[n];var r=this._contextNameToData[n];delete this._contextNameToData[n],r&&r.isAnnounced||this._logger.error("Received 'destroyed' for unknown context: "+e)},t.prototype.sendSubscribe=function(t){return t.sentExplicitSubscription=!0,this._gw3Session.send({type:"subscribe-context",domain:"global",context_id:t.contextId}).then((function(t){}))},t.prototype.sendUnsubscribe=function(t){return t.sentExplicitSubscription=!1,this._gw3Session.send({type:"unsubscribe-context",domain:"global",context_id:t.contextId}).then((function(t){}))},t.prototype.calculateContextDelta=function(t,e){var n={added:{},updated:{},removed:[],reset:void 0};if(t)for(var r=0,o=Object.keys(t);r<o.length;r++){var i=o[r];-1===Object.keys(e).indexOf(i)||null===e[i]||dn(t[i],e[i])||(n.updated[i]=e[i])}for(var s=0,a=Object.keys(e);s<a.length;s++){i=a[s];t&&-1!==Object.keys(t).indexOf(i)?null===e[i]&&n.removed.push(i):null!==e[i]&&(n.added[i]=e[i])}return n},t}(),hn=function(){function t(t){this._bridge=new ln(t)}return t.prototype.all=function(){return this._bridge.all()},t.prototype.update=function(t,e){return this.checkName(t),this._bridge.update(t,e)},t.prototype.set=function(t,e){return this.checkName(t),this._bridge.set(t,e)},t.prototype.subscribe=function(t,e){var n=this;return this.checkName(t),this._bridge.subscribe(t,(function(t,r,o,i,s){return e(t,r,o,(function(){return n._bridge.unsubscribe(i)}),s)})).then((function(t){return function(){n._bridge.unsubscribe(t)}}))},t.prototype.get=function(t,e){return void 0===e&&(e=!0),this._bridge.get(t,e)},t.prototype.ready=function(){return Promise.resolve(this)},t.prototype.checkName=function(t){if("string"!=typeof t||""===t)throw new Error("'name' must be non-empty string, got '"+t+"'")},t}();function fn(t,e,n){return"function"!=typeof e&&"function"!=typeof n?t:("function"!=typeof e?e=function(){}:"function"!=typeof n&&(n=function(){}),t.then(e,n))}function vn(t,e){return void 0===t&&(t=0),new Promise((function(n,r){return setTimeout((function(){return r(e)}),t)}))}!function(t){t[t.Success=0]="Success",t[t.Error=1]="Error"}(pn||(pn={}));var gn=function(){function t(t,e,n,r){this.protocol=t,this.repo=e,this.instance=n,this.configuration=r}return t.prototype.subscribe=function(t,e,n,r,o){var i=this,s=function(t,n,r,s){var a;e.methodResponseTimeout=null!==(a=e.methodResponseTimeout)&&void 0!==a?a:e.waitTimeoutMs,i.protocol.client.subscribe(n,e,t,r,s,o)};return fn(new Promise((function(n,r){var o,a=function(t){n(t)},c=function(t){r(t)};if(t)if((o="string"==typeof t?{name:t}:t).name){void 0===e&&(e={});var u=e.target;if(void 0===u&&(u="best"),"string"!=typeof u||"all"===u||"best"===u){void 0===e.methodResponseTimeout&&(e.methodResponseTimeout=e.method_response_timeout,void 0===e.methodResponseTimeout&&(e.methodResponseTimeout=i.configuration.methodResponseTimeout)),void 0===e.waitTimeoutMs&&(e.waitTimeoutMs=e.wait_for_method_timeout,void 0===e.waitTimeoutMs&&(e.waitTimeoutMs=i.configuration.waitTimeoutMs));var d=0,p=i.getServerMethodsByFilterAndTarget(o,u);if(p.length>0)s(p,p[0].methods[0],a,c);else{var l=function(){if(u&&e.waitTimeoutMs)if(d+=500,(p=i.getServerMethodsByFilterAndTarget(o,u)).length>0){var n=p[0].methods[0];s(p,n,a,c)}else if(d>=e.waitTimeoutMs){s(p,"string"==typeof t?{name:t}:t,a,c)}else setTimeout(l,500)};setTimeout(l,500)}}else r(new Error('"'+u+'" is not a valid target. Valid targets are "all", "best", or an instance.'))}else r("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");else r("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.")})),n,r)},t.prototype.servers=function(t){var e=void 0===t?void 0:ne({},t);return this.getServers(e).map((function(t){return t.server.instance}))},t.prototype.methods=function(t){return t="string"==typeof t?{name:t}:ne({},t),this.getMethods(t)},t.prototype.methodsForInstance=function(t){return this.getMethodsForInstance(t)},t.prototype.methodAdded=function(t){return this.repo.onMethodAdded(t)},t.prototype.methodRemoved=function(t){return this.repo.onMethodRemoved(t)},t.prototype.serverAdded=function(t){return this.repo.onServerAdded(t)},t.prototype.serverRemoved=function(t){return this.repo.onServerRemoved((function(e,n){t(e,n)}))},t.prototype.serverMethodAdded=function(t){return this.repo.onServerMethodAdded((function(e,n){t({server:e,method:n})}))},t.prototype.serverMethodRemoved=function(t){return this.repo.onServerMethodRemoved((function(e,n){t({server:e,method:n})}))},t.prototype.invoke=function(t,e,n,r,o,i){return re(this,void 0,void 0,(function(){var s=this;return oe(this,(function(a){return[2,fn(function(){return re(s,void 0,void 0,(function(){var o,i,s,a,c,u,d,p,l,h,f=this;return oe(this,(function(v){switch(v.label){case 0:if(!(o="string"==typeof t?{name:t}:ne({},t)).name)return[2,Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.")];if(e||(e={}),n||(n="best"),"string"==typeof n&&"all"!==n&&"best"!==n&&"skipMine"!==n)return[2,Promise.reject(new Error('"'+n+'" is not a valid target. Valid targets are "all" and "best".'))];if(r||(r={}),void 0===r.methodResponseTimeoutMs&&(r.methodResponseTimeoutMs=r.method_response_timeout,void 0===r.methodResponseTimeoutMs&&(r.methodResponseTimeoutMs=this.configuration.methodResponseTimeout)),void 0===r.waitTimeoutMs&&(r.waitTimeoutMs=r.wait_for_method_timeout,void 0===r.waitTimeoutMs&&(r.waitTimeoutMs=this.configuration.waitTimeoutMs)),void 0!==r.waitTimeoutMs&&"number"!=typeof r.waitTimeoutMs)return[2,Promise.reject(new Error('"'+r.waitTimeoutMs+'" is not a valid number for "waitTimeoutMs" '))];if("object"!=typeof e)return[2,Promise.reject(new Error("The method arguments must be an object. method: "+o.name))];if(0!==(i=this.getServerMethodsByFilterAndTarget(o,n)).length)return[3,4];v.label=1;case 1:return v.trys.push([1,3,,4]),[4,this.tryToAwaitForMethods(o,n,r)];case 2:return i=v.sent(),[3,4];case 3:return v.sent(),s=ne(ne({},o),{getServers:function(){return[]},supportsStreaming:!1,objectTypes:null!==(h=o.objectTypes)&&void 0!==h?h:[]}),a={method:s,called_with:e,message:"Can not find a method matching "+JSON.stringify(t)+" with server filter "+JSON.stringify(n),executed_by:void 0,returned:void 0,status:void 0},[2,Promise.reject(a)];case 4:return c=r.methodResponseTimeoutMs,u=r,d=i.map((function(t){var n=Ye(),r=f.protocol.client.invoke(n,t.methods[0],e,t.server,u);return Promise.race([r,vn(c,{invocationId:n,message:"Invocation timeout ("+c+" ms) reached",status:pn.Error})])})),[4,Promise.all(d)];case 5:return p=v.sent(),l=this.getInvocationResultObj(p,o,e),p.every((function(t){return t.status===pn.Error}))?[2,Promise.reject(l)]:[2,l]}}))}))}(),o,i)]}))}))},t.prototype.getInvocationResultObj=function(t,e,n){var r=t.filter((function(t){return t.status===pn.Success})).reduce((function(t,r){return t=ie(t,[{executed_by:r.instance,returned:r.result,called_with:n,method:e,message:r.message,status:r.status}])}),[]),o=t.filter((function(t){return t.status===pn.Error})).reduce((function(t,r){return t=ie(t,[{executed_by:r.instance,called_with:n,name:e.name,message:r.message}])}),[]),i=t[0];return{method:e,called_with:n,returned:i.result,executed_by:i.instance,all_return_values:r,all_errors:o,message:i.message,status:i.status}},t.prototype.tryToAwaitForMethods=function(t,e,n){var r=this;return new Promise((function(o,i){if(0!==n.waitTimeoutMs)var s=0,a=setInterval((function(){s+=500;var c=r.getServerMethodsByFilterAndTarget(t,e);if(c.length>0)clearInterval(a),o(c);else if(s>=(n.waitTimeoutMs||1e4))return clearInterval(a),void i()}),500);else i()}))},t.prototype.filterByTarget=function(t,e){var n=this;if("string"!=typeof t){return(Array.isArray(t)?t:[t]).reduce((function(t,r){var o=e.filter((function(t){return n.instanceMatch(r,t.server.instance)}));return t.concat(o)}),[])}if("all"===t)return ie(e);if("best"===t){var r=e.find((function(t){return t.server.instance.isLocal}));if(r)return[r];if(void 0!==e[0])return[e[0]]}else if("skipMine"===t)return e.filter((function(t){return t.server.instance.peerId!==n.instance.peerId}));return[]},t.prototype.instanceMatch=function(t,e){return this.containsProps(t,e)},t.prototype.methodMatch=function(t,e){return this.containsProps(t,e)},t.prototype.containsProps=function(t,e){return Object.keys(t).filter((function(e){return void 0!==t[e]&&"function"!=typeof t[e]&&"object_types"!==e&&"display_name"!==e&&"id"!==e&&"gatewayId"!==e&&"identifier"!==e&&"_"!==e[0]})).reduce((function(n,r){var o=t[r],i=e[r];if("objectTypes"===r){(o.length>i.length||!1===function(t,e){var n=t.reduce((function(t,e){return t[e]=!1,t}),{});e.forEach((function(t){void 0!==n[t]&&(n[t]=!0)}));return Object.keys(n).reduce((function(t,e){return n[e]||(t=!1),t}),!0)}(o,i))&&(n=!1)}else String(o).toLowerCase()!==String(i).toLowerCase()&&(n=!1);return n}),!0)},t.prototype.getMethods=function(t){var e=this;return void 0===t?this.repo.getMethods():this.repo.getMethods().filter((function(n){return e.methodMatch(t,n)}))},t.prototype.getMethodsForInstance=function(t){var e=this,n=this.repo.getServers().filter((function(n){return e.instanceMatch(t,n.instance)}));if(0===n.length)return[];var r={};return 1===n.length?r=n[0].methods:n.forEach((function(t){Object.keys(t.methods).forEach((function(e){var n=t.methods[e];r[n.identifier]=n}))})),Object.keys(r).map((function(t){return r[t]}))},t.prototype.getServers=function(t){var e=this,n=this.repo.getServers();return void 0===t?n.map((function(t){return{server:t,methods:[]}})):n.reduce((function(n,r){var o=e.repo.getServerMethodsById(r.id).filter((function(n){return e.methodMatch(t,n)}));return o.length>0&&n.push({server:r,methods:o}),n}),[])},t.prototype.getServerMethodsByFilterAndTarget=function(t,e){var n=this.getServers(t);return this.filterByTarget(e,n)},t}(),mn=function(){function t(t,e,n){this.protocol=t,this.repoMethod=e,this.subscription=n}return Object.defineProperty(t.prototype,"stream",{get:function(){if(!this.repoMethod.stream)throw new Error("no stream");return this.repoMethod.stream},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"arguments",{get:function(){return this.subscription.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"branchKey",{get:function(){return this.subscription.branchKey},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"instance",{get:function(){if(!this.subscription.instance)throw new Error("no instance");return this.subscription.instance},enumerable:!0,configurable:!0}),t.prototype.close=function(){this.protocol.server.closeSingleSubscription(this.repoMethod,this.subscription)},t.prototype.push=function(t){this.protocol.server.pushDataToSingle(this.repoMethod,this.subscription,t)},t}(),yn=function(){function t(t,e,n){this.protocol=t,this.repoMethod=e,this.requestContext=n,this.arguments=n.arguments,this.instance=n.instance}return t.prototype.accept=function(){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,"")},t.prototype.acceptOnBranch=function(t){this.protocol.server.acceptRequestOnBranch(this.requestContext,this.repoMethod,t)},t.prototype.reject=function(t){this.protocol.server.rejectRequest(this.requestContext,this.repoMethod,t)},t}(),bn=function(){function t(t,e){var n=this;this.protocol=t,this.server=e,t.server.onSubRequest((function(t,e){return n.handleSubRequest(t,e)})),t.server.onSubAdded((function(t,e){return n.handleSubAdded(t,e)})),t.server.onSubRemoved((function(t,e){return n.handleSubRemoved(t,e)}))}return t.prototype.handleSubRequest=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionRequestHandler){var n=new yn(this.protocol,e,t);e.streamCallbacks.subscriptionRequestHandler(n)}},t.prototype.handleSubAdded=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionAddedHandler){var n=new mn(this.protocol,e,t);e.streamCallbacks.subscriptionAddedHandler(n)}},t.prototype.handleSubRemoved=function(t,e){if(e&&e.streamCallbacks&&"function"==typeof e.streamCallbacks.subscriptionRemovedHandler){var n=new mn(this.protocol,e,t);e.streamCallbacks.subscriptionRemovedHandler(n)}},t}(),wn=function(){function t(t,e,n){this.key=t,this.protocol=e,this.repoMethod=n}return t.prototype.subscriptions=function(){var t=this;return this.protocol.server.getSubscriptionList(this.repoMethod,this.key).map((function(e){return new mn(t.protocol,t.repoMethod,e)}))},t.prototype.close=function(){this.protocol.server.closeAllSubscriptions(this.repoMethod,this.key)},t.prototype.push=function(t){this.protocol.server.pushData(this.repoMethod,t,[this.key])},t}(),Sn=function(){function t(t,e,n){this._protocol=t,this._repoMethod=e,this._server=n,this.name=this._repoMethod.definition.name}return t.prototype.branches=function(t){var e=this,n=this._protocol.server.getBranchList(this._repoMethod);return t?n.indexOf(t)>-1?new wn(t,this._protocol,this._repoMethod):void 0:n.map((function(t){return new wn(t,e._protocol,e._repoMethod)}))},t.prototype.branch=function(t){return this.branches(t)},t.prototype.subscriptions=function(){var t=this;return this._protocol.server.getSubscriptionList(this._repoMethod).map((function(e){return new mn(t._protocol,t._repoMethod,e)}))},Object.defineProperty(t.prototype,"definition",{get:function(){var t=this._repoMethod.definition;return{accepts:t.accepts,description:t.description,displayName:t.displayName,name:t.name,objectTypes:t.objectTypes,returns:t.returns,supportsStreaming:t.supportsStreaming}},enumerable:!0,configurable:!0}),t.prototype.close=function(){this._protocol.server.closeAllSubscriptions(this._repoMethod),this._server.unregister(this._repoMethod.definition,!0)},t.prototype.push=function(t,e){if("string"!=typeof e&&!Array.isArray(e)&&void 0!==e)throw new Error("invalid branches should be string or string array");if("object"!=typeof t)throw new Error("Invalid arguments. Data must be an object.");this._protocol.server.pushData(this._repoMethod,t,e)},t.prototype.updateRepoMethod=function(t){this._repoMethod=t},t}(),xn=function(){function t(t,e){this.protocol=t,this.serverRepository=e,this.invocations=0,this.currentlyUnregistering={},this.streaming=new bn(t,this),this.protocol.server.onInvoked(this.onMethodInvoked.bind(this))}return t.prototype.createStream=function(t,e,n,r,o){var i=this;return fn(new Promise((function(n,r){if(t){var s;if(!(s="string"==typeof t?{name:""+t}:ne({},t)).name)return r("The “name” property is required for the “streamDefinition” object and must be unique. Stream definition: "+JSON.stringify(s));if(i.serverRepository.getList().some((function(t){return t.definition.name===s.name})))return r('A stream with the name "'+s.name+'" already exists! Please, provide a unique name for the stream.');s.supportsStreaming=!0,e||(e={}),"function"!=typeof e.subscriptionRequestHandler&&(e.subscriptionRequestHandler=function(t){t.accept()});var a=i.serverRepository.add({definition:s,streamCallbacks:e,protocolState:{}});i.protocol.server.createStream(a).then((function(){var t;o?(t=o,o.updateRepoMethod(a)):t=new Sn(i.protocol,a,i),a.stream=t,n(t)})).catch((function(t){a.repoId&&i.serverRepository.remove(a.repoId),r(t)}))}else r("The stream name must be unique! Please, provide either a unique string for a stream name to “glue.interop.createStream()” or a “methodDefinition” object with a unique “name” property for the stream.")})),n,r)},t.prototype.register=function(t,e){var n=this;if(!t)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof e)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof t?t:t.name));var r=function(t,r){return re(n,void 0,void 0,(function(){var n,o,i;return oe(this,(function(s){switch(s.label){case 0:return s.trys.push([0,4,,5]),(n=e(t.args,t.instance))&&"function"==typeof n.then?[4,n]:[3,2];case 1:return o=s.sent(),r(void 0,o),[3,3];case 2:r(void 0,n),s.label=3;case 3:return[3,5];case 4:return(i=s.sent())||(i=""),r(i,i),[3,5];case 5:return[2]}}))}))};return r.userCallback=e,this.registerCore(t,r)},t.prototype.registerAsync=function(t,e){if(!t)return Promise.reject("Method definition is required. Please, provide either a unique string for a method name or a “methodDefinition” object with a required “name” property.");if("function"!=typeof e)return Promise.reject("The second parameter must be a callback function. Method: "+("string"==typeof t?t:t.name));var n=function(t,n){try{var r=!1,o=function(t){r||n(void 0,t),r=!0},i=function(t){r||(t||(t=""),n(t,t)),r=!0},s=e(t.args,t.instance,o,i);s&&"function"==typeof s.then&&s.then(o).catch(i)}catch(t){n(t,void 0)}};return n.userCallbackAsync=e,this.registerCore(t,n)},t.prototype.unregister=function(t,e){return void 0===e&&(e=!1),re(this,void 0,void 0,(function(){var n,r;return oe(this,(function(o){switch(o.label){case 0:return void 0===t?[2,Promise.reject("Please, provide either a unique string for a name or an object containing a “name” property.")]:"function"!=typeof t?[3,2]:[4,this.unregisterWithPredicate(t,e)];case 1:return o.sent(),[2];case 2:return void 0===(n="string"==typeof t?{name:t}:t).name?[2,Promise.reject("Method name is required. Cannot find a method if the method name is undefined!")]:(r=this.serverRepository.getList().find((function(t){return t.definition.name===n.name&&(t.definition.supportsStreaming||!1)===e})))?[4,this.removeMethodsOrStreams([r])]:[2,Promise.reject('Method with a name "'+n.name+'" does not exist or is not registered by your application!')];case 3:return o.sent(),[2]}}))}))},t.prototype.unregisterWithPredicate=function(t,e){return re(this,void 0,void 0,(function(){var n;return oe(this,(function(r){switch(r.label){case 0:return(n=this.serverRepository.getList().filter((function(e){return t(e.definition)})).filter((function(t){return(t.definition.supportsStreaming||!1)===e})))&&0!==n.length?[4,this.removeMethodsOrStreams(n)]:[2,Promise.reject("Could not find a "+(e?"stream":"method")+" matching the specified condition!")];case 1:return r.sent(),[2]}}))}))},t.prototype.removeMethodsOrStreams=function(t){var e=this,n=[];return t.forEach((function(t){var r=e.protocol.server.unregister(t).then((function(){t.repoId&&e.serverRepository.remove(t.repoId)}));n.push(r),e.addAsCurrentlyUnregistering(t.definition.name,r)})),Promise.all(n)},t.prototype.addAsCurrentlyUnregistering=function(t,e){return re(this,void 0,void 0,(function(){var n,r=this;return oe(this,(function(o){return n=new Promise((function(t){return setTimeout(t,5e3)})),this.currentlyUnregistering[t]=Promise.race([e,n]).then((function(){delete r.currentlyUnregistering[t]})),[2]}))}))},t.prototype.registerCore=function(t,e){return re(this,void 0,void 0,(function(){var n,r,o,i=this;return oe(this,(function(s){switch(s.label){case 0:return(n="string"==typeof t?{name:""+t}:ne({},t)).name?(r=this.currentlyUnregistering[n.name])?[4,r]:[3,2]:[2,Promise.reject("Please, provide a (unique) string value for the “name” property in the “methodDefinition” object: "+JSON.stringify(t))];case 1:s.sent(),s.label=2;case 2:return this.serverRepository.getList().some((function(t){return t.definition.name===n.name}))?[2,Promise.reject('A method with the name "'+n.name+'" already exists! Please, provide a unique name for the method.')]:n.supportsStreaming?[2,Promise.reject("When you create methods with “glue.interop.register()” or “glue.interop.registerAsync()” the property “supportsStreaming” cannot be “true”. If you want “"+n.name+"” to be a stream, please use the “glue.interop.createStream()” method.")]:(o=this.serverRepository.add({definition:n,theFunction:e,protocolState:{}}),[2,this.protocol.server.register(o).catch((function(t){throw(null==o?void 0:o.repoId)&&i.serverRepository.remove(o.repoId),t}))])}}))}))},t.prototype.onMethodInvoked=function(t,e,n){var r=this;t&&t.theFunction&&t.theFunction(n,(function(n,o){if(null!=n)if(n.message&&"string"==typeof n.message)n=n.message;else if("string"!=typeof n)try{n=JSON.stringify(n)}catch(t){n="un-stringifyable error in onMethodInvoked! Top level prop names: "+Object.keys(n)}o?("object"!=typeof o||Array.isArray(o))&&(o={_value:o}):o={},r.protocol.server.methodInvocationResult(t,e,n,o)}))},t}(),_n=function(){function t(t,e){var n=this;this.wrapped={getMethods:kn,getStreams:In},t&&this.refreshWrappedObject(t),e&&(e.loggedIn((function(){n.refresh(e)})),this.refresh(e))}return t.prototype.unwrap=function(){return this.wrapped},t.prototype.refresh=function(t){if(t){var e=null==t?void 0:t.resolvedIdentity,n=Object.assign({},null!=e?e:{},{peerId:null==t?void 0:t.peerId});this.refreshWrappedObject(n)}},t.prototype.refreshWrappedObject=function(t){var e,n,r;this.wrapped.user=t.user,this.wrapped.instance=t.instance,this.wrapped.application=null!==(e=t.application)&&void 0!==e?e:Ye(),this.wrapped.applicationName=t.applicationName,this.wrapped.pid=null!==(r=null!==(n=t.pid)&&void 0!==n?n:t.process)&&void 0!==r?r:Math.floor(1e10*Math.random()),this.wrapped.machine=t.machine,this.wrapped.environment=t.environment,this.wrapped.region=t.region,this.wrapped.windowId=t.windowId,this.wrapped.isLocal=!0,this.wrapped.api=t.api,this.wrapped.service=t.service,this.wrapped.peerId=t.peerId},t}();function kn(){var t;return null===(t=_n.API)||void 0===t?void 0:t.methodsForInstance(this)}function In(){var t;return null===(t=_n.API)||void 0===t?void 0:t.methodsForInstance(this).filter((function(t){return t.supportsStreaming}))}var jn=function(){function t(t){this.logger=t,this.servers={},this.methodsCount={},this.callbacks=je()}return t.prototype.addServer=function(t,e){this.logger.debug("adding server "+e);var n=this.servers[e];if(n)return n.id;var r=new _n(t),o={id:e,methods:{},instance:r.unwrap(),wrapper:r};return this.servers[e]=o,this.callbacks.execute("onServerAdded",o.instance),e},t.prototype.removeServerById=function(t,e){var n=this,r=this.servers[t];r?(this.logger.debug("removing server "+t),Object.keys(r.methods).forEach((function(e){n.removeServerMethod(t,e)})),delete this.servers[t],this.callbacks.execute("onServerRemoved",r.instance,e)):this.logger.warn("not aware of server "+t+", my state "+JSON.stringify(Object.keys(this.servers)))},t.prototype.addServerMethod=function(t,e){var n=this.servers[t];if(!n)throw new Error("server does not exists");if(!n.methods[e.id]){var r=this.createMethodIdentifier(e),o=this,i={identifier:r,gatewayId:e.id,name:e.name,displayName:e.display_name,description:e.description,version:e.version,objectTypes:e.object_types||[],accepts:e.input_signature,returns:e.result_signature,supportsStreaming:void 0!==e.flags&&e.flags.streaming,getServers:function(){return o.getServersByMethod(r)}};return i.object_types=i.objectTypes,i.display_name=i.displayName,i.version=i.version,n.methods[e.id]=i,this.methodsCount[r]||(this.methodsCount[r]=0,this.callbacks.execute("onMethodAdded",i)),this.methodsCount[r]=this.methodsCount[r]+1,this.callbacks.execute("onServerMethodAdded",n.instance,i),i}},t.prototype.removeServerMethod=function(t,e){var n=this.servers[t];if(!n)throw new Error("server does not exists");var r=n.methods[e];delete n.methods[e],this.methodsCount[r.identifier]=this.methodsCount[r.identifier]-1,0===this.methodsCount[r.identifier]&&this.callbacks.execute("onMethodRemoved",r),this.callbacks.execute("onServerMethodRemoved",n.instance,r)},t.prototype.getMethods=function(){var t=this,e={};return Object.keys(this.servers).forEach((function(n){var r=t.servers[n];Object.keys(r.methods).forEach((function(t){var n=r.methods[t];e[n.identifier]=n}))})),Object.keys(e).map((function(t){return e[t]}))},t.prototype.getServers=function(){var t=this,e=[];return Object.keys(this.servers).forEach((function(n){var r=t.servers[n];e.push(r)})),e},t.prototype.getServerMethodsById=function(t){var e=this.servers[t];return Object.keys(e.methods).map((function(t){return e.methods[t]}))},t.prototype.onServerAdded=function(t){var e=this.callbacks.add("onServerAdded",t),n=this.getServers().map((function(t){return t.instance}));return this.returnUnsubWithDelayedReplay(e,n,t)},t.prototype.onMethodAdded=function(t){var e=this.callbacks.add("onMethodAdded",t),n=this.getMethods();return this.returnUnsubWithDelayedReplay(e,n,t)},t.prototype.onServerMethodAdded=function(t){var e=this.callbacks.add("onServerMethodAdded",t),n=!1,r=this.getServers();return setTimeout((function(){r.forEach((function(e){var r=e.methods;Object.keys(r).forEach((function(o){n||t(e.instance,r[o])}))}))}),0),function(){n=!0,e()}},t.prototype.onMethodRemoved=function(t){return this.callbacks.add("onMethodRemoved",t)},t.prototype.onServerRemoved=function(t){return this.callbacks.add("onServerRemoved",t)},t.prototype.onServerMethodRemoved=function(t){return this.callbacks.add("onServerMethodRemoved",t)},t.prototype.getServerById=function(t){return this.servers[t]},t.prototype.reset=function(){var t=this;Object.keys(this.servers).forEach((function(e){t.removeServerById(e,"reset")})),this.servers={},this.methodsCount={}},t.prototype.createMethodIdentifier=function(t){var e=void 0!==t.input_signature?t.input_signature:"",n=void 0!==t.result_signature?t.result_signature:"";return(t.name+e+n).toLowerCase()},t.prototype.getServersByMethod=function(t){var e=this,n=[];return Object.keys(this.servers).forEach((function(r){var o=e.servers[r];Object.keys(o.methods).forEach((function(e){o.methods[e].identifier===t&&n.push(o.instance)}))})),n},t.prototype.returnUnsubWithDelayedReplay=function(t,e,n){var r=!1;return setTimeout((function(){e.forEach((function(t){r||n(t)}))}),0),function(){r=!0,t()}},t}(),Tn=function(){function t(){this.nextId=0,this.methods=[]}return t.prototype.add=function(t){return t.repoId=String(this.nextId),this.nextId+=1,this.methods.push(t),t},t.prototype.remove=function(t){if("string"!=typeof t)return new TypeError("Expecting a string");this.methods=this.methods.filter((function(e){return e.repoId!==t}))},t.prototype.getById=function(t){if("string"==typeof t)return this.methods.find((function(e){return e.repoId===t}))},t.prototype.getList=function(){return this.methods.map((function(t){return t}))},t.prototype.length=function(){return this.methods.length},t.prototype.reset=function(){this.methods=[]},t}(),Mn=function(){function t(t,e,n){var r=this;this.session=t,this.repository=e,this.serverRepository=n,this.ERR_URI_SUBSCRIPTION_FAILED="com.tick42.agm.errors.subscription.failure",this.callbacks=je(),this.nextStreamId=0,t.on("add-interest",(function(t){r.handleAddInterest(t)})),t.on("remove-interest",(function(t){r.handleRemoveInterest(t)}))}return t.prototype.acceptRequestOnBranch=function(t,e,n){if("string"!=typeof n&&(n=""),"object"!=typeof e.protocolState.subscriptionsMap)throw new TypeError("The streaming method is missing its subscriptions.");if(!Array.isArray(e.protocolState.branchKeyToStreamIdMap))throw new TypeError("The streaming method is missing its branches.");var r=this.getStreamId(e,n),o=t.msg.subscription_id,i={id:o,arguments:t.arguments,instance:t.instance,branchKey:n,streamId:r,subscribeMsg:t.msg};e.protocolState.subscriptionsMap[o]=i,this.session.sendFireAndForget({type:"accepted",subscription_id:o,stream_id:r}),this.callbacks.execute("onSubscriptionAdded",i,e)},t.prototype.rejectRequest=function(t,e,n){"string"!=typeof n&&(n=""),this.sendSubscriptionFailed("Subscription rejected by user. "+n,t.msg.subscription_id)},t.prototype.pushData=function(t,e,n){var r=this;if("object"==typeof t&&Array.isArray(t.protocolState.branchKeyToStreamIdMap)){if("object"!=typeof e)throw new Error("Invalid arguments. Data must be an object.");"string"==typeof n?n=[n]:(!Array.isArray(n)||n.length<=0)&&(n=[]),t.protocolState.branchKeyToStreamIdMap.filter((function(t){return!n||0===n.length||n.indexOf(t.key)>=0})).map((function(t){return t.streamId})).forEach((function(t){var n={type:"publish",stream_id:t,data:e};r.session.sendFireAndForget(n)}))}},t.prototype.pushDataToSingle=function(t,e,n){if("object"!=typeof n)throw new Error("Invalid arguments. Data must be an object.");var r={type:"post",subscription_id:e.id,data:n};this.session.sendFireAndForget(r)},t.prototype.closeSingleSubscription=function(t,e){t.protocolState.subscriptionsMap&&delete t.protocolState.subscriptionsMap[e.id];var n={type:"drop-subscription",subscription_id:e.id,reason:"Server dropping a single subscription"};this.session.sendFireAndForget(n);e.instance;this.callbacks.execute("onSubscriptionRemoved",e,t)},t.prototype.closeMultipleSubscriptions=function(t,e){var n=this;if("object"==typeof t&&"object"==typeof t.protocolState.subscriptionsMap&&t.protocolState.subscriptionsMap){var r=t.protocolState.subscriptionsMap,o=Object.keys(r).map((function(t){return r[t]}));"string"==typeof e&&(o=o.filter((function(t){return t.branchKey===e}))),o.forEach((function(t){delete r[t.id];var e={type:"drop-subscription",subscription_id:t.id,reason:"Server dropping all subscriptions on stream_id: "+t.streamId};n.session.sendFireAndForget(e)}))}},t.prototype.getSubscriptionList=function(t,e){if("object"!=typeof t)return[];if(!t.protocolState.subscriptionsMap)return[];var n=t.protocolState.subscriptionsMap,r=Object.keys(n).map((function(t){return n[t]}));return"string"!=typeof e?r:r.filter((function(t){return t.branchKey===e}))},t.prototype.getBranchList=function(t){if("object"!=typeof t)return[];if(!t.protocolState.subscriptionsMap)return[];var e=t.protocolState.subscriptionsMap,n=Object.keys(e).map((function(t){return e[t]})),r=[];return n.forEach((function(t){var e="";"object"==typeof t&&"string"==typeof t.branchKey&&(e=t.branchKey),-1===r.indexOf(e)&&r.push(e)})),r},t.prototype.onSubAdded=function(t){this.onSubscriptionLifetimeEvent("onSubscriptionAdded",t)},t.prototype.onSubRequest=function(t){this.onSubscriptionLifetimeEvent("onSubscriptionRequest",t)},t.prototype.onSubRemoved=function(t){this.onSubscriptionLifetimeEvent("onSubscriptionRemoved",t)},t.prototype.handleRemoveInterest=function(t){var e=this.serverRepository.getById(t.method_id);if("string"==typeof t.subscription_id&&"object"==typeof e&&e.protocolState.subscriptionsMap&&"object"==typeof e.protocolState.subscriptionsMap[t.subscription_id]){var n=e.protocolState.subscriptionsMap[t.subscription_id];delete e.protocolState.subscriptionsMap[t.subscription_id],this.callbacks.execute("onSubscriptionRemoved",n,e)}},t.prototype.onSubscriptionLifetimeEvent=function(t,e){this.callbacks.add(t,e)},t.prototype.getNextStreamId=function(){return this.nextStreamId+++""},t.prototype.handleAddInterest=function(t){var e=this.repository.getServerById(t.caller_id).instance,n={msg:t,arguments:t.arguments_kv||{},instance:e},r=this.serverRepository.getById(t.method_id);if(void 0!==r)r.protocolState.subscriptionsMap&&r.protocolState.subscriptionsMap[t.subscription_id]?this.sendSubscriptionFailed("A subscription with id "+t.subscription_id+" already exists.",t.subscription_id):this.callbacks.execute("onSubscriptionRequest",n,r);else{var o="No method with id "+t.method_id+" on this server.";this.sendSubscriptionFailed(o,t.subscription_id)}},t.prototype.sendSubscriptionFailed=function(t,e){var n={type:"error",reason_uri:this.ERR_URI_SUBSCRIPTION_FAILED,reason:t,request_id:e};this.session.sendFireAndForget(n)},t.prototype.getStreamId=function(t,e){if("string"!=typeof e&&(e=""),!t.protocolState.branchKeyToStreamIdMap)throw new Error("streaming "+t.definition.name+" method without protocol state");var n=t.protocolState.branchKeyToStreamIdMap.filter((function(t){return t.key===e}))[0],r=n?n.streamId:void 0;return"string"==typeof r&&""!==r||(r=this.getNextStreamId(),t.protocolState.branchKeyToStreamIdMap.push({key:e,streamId:r})),r},t}(),Cn=function(){function t(t,e,n,r){var o=this;this.session=t,this.clientRepository=e,this.serverRepository=n,this.logger=r,this.callbacks=je(),this.streaming=new Mn(t,e,n),this.session.on("invoke",(function(t){return o.handleInvokeMessage(t)}))}return t.prototype.createStream=function(t){return t.protocolState.subscriptionsMap={},t.protocolState.branchKeyToStreamIdMap=[],this.register(t,!0)},t.prototype.register=function(t,e){var n=this,r=t.definition,o={streaming:e||!1},i={type:"register",methods:[{id:t.repoId,name:r.name,display_name:r.displayName,description:r.description,version:r.version,flags:o,object_types:r.objectTypes||r.object_types,input_signature:r.accepts,result_signature:r.returns,restrictions:void 0}]};return this.session.send(i,{methodId:t.repoId}).then((function(){n.logger.debug("registered method "+t.definition.name+" with id "+t.repoId)})).catch((function(e){throw n.logger.warn("failed to register method "+t.definition.name+" with id "+t.repoId+" - "+JSON.stringify(e)),e}))},t.prototype.onInvoked=function(t){this.callbacks.add("onInvoked",t)},t.prototype.methodInvocationResult=function(t,e,n,r){var o;o=n||""===n?{type:"error",request_id:e,reason_uri:"agm.errors.client_error",reason:n,context:r,peer_id:void 0}:{type:"yield",invocation_id:e,peer_id:this.session.peerId,result:r,request_id:void 0},this.session.sendFireAndForget(o)},t.prototype.unregister=function(t){return re(this,void 0,void 0,(function(){var e;return oe(this,(function(n){switch(n.label){case 0:return e={type:"unregister",methods:[t.repoId]},[4,this.session.send(e)];case 1:return n.sent(),[2]}}))}))},t.prototype.getBranchList=function(t){return this.streaming.getBranchList(t)},t.prototype.getSubscriptionList=function(t,e){return this.streaming.getSubscriptionList(t,e)},t.prototype.closeAllSubscriptions=function(t,e){this.streaming.closeMultipleSubscriptions(t,e)},t.prototype.pushData=function(t,e,n){this.streaming.pushData(t,e,n)},t.prototype.pushDataToSingle=function(t,e,n){this.streaming.pushDataToSingle(t,e,n)},t.prototype.closeSingleSubscription=function(t,e){this.streaming.closeSingleSubscription(t,e)},t.prototype.acceptRequestOnBranch=function(t,e,n){this.streaming.acceptRequestOnBranch(t,e,n)},t.prototype.rejectRequest=function(t,e,n){this.streaming.rejectRequest(t,e,n)},t.prototype.onSubRequest=function(t){this.streaming.onSubRequest(t)},t.prototype.onSubAdded=function(t){this.streaming.onSubAdded(t)},t.prototype.onSubRemoved=function(t){this.streaming.onSubRemoved(t)},t.prototype.handleInvokeMessage=function(t){var e=t.invocation_id,n=t.caller_id,r=t.method_id,o=t.arguments_kv,i=this.serverRepository.getList().filter((function(t){return t.repoId===r}))[0];if(void 0!==i){var s={args:o,instance:this.clientRepository.getServerById(n).instance};this.callbacks.execute("onInvoked",i,e,s)}},t}(),On=function(){function t(t,e){this.repository=t,this.subscriptionData=e}return Object.defineProperty(t.prototype,"requestArguments",{get:function(){return this.subscriptionData.params.arguments||{}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"servers",{get:function(){var t=this;return this.subscriptionData.trackedServers.filter((function(t){return t.subscriptionId})).map((function(e){return t.repository.getServerById(e.serverId).instance}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"serverInstance",{get:function(){return this.servers[0]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"stream",{get:function(){return this.subscriptionData.method},enumerable:!0,configurable:!0}),t.prototype.onData=function(t){if("function"!=typeof t)throw new TypeError("The data callback must be a function.");this.subscriptionData.handlers.onData.push(t),1===this.subscriptionData.handlers.onData.length&&this.subscriptionData.queued.data.length>0&&this.subscriptionData.queued.data.forEach((function(e){t(e)}))},t.prototype.onClosed=function(t){if("function"!=typeof t)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onClosed.push(t)},t.prototype.onFailed=function(t){},t.prototype.onConnected=function(t){if("function"!=typeof t)throw new TypeError("The callback must be a function.");this.subscriptionData.handlers.onConnected.push(t)},t.prototype.close=function(){this.subscriptionData.close()},t.prototype.setNewSubscription=function(t){this.subscriptionData=t},t}(),En=function(){function t(t,e,n){var r=this;this.session=t,this.repository=e,this.logger=n,this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},this.nextSubLocalKey=0,this.handleErrorSubscribing=function(t){var e=t._tag,n=e.subLocalKey,o=r.subscriptionsList[n];if("object"==typeof o&&(o.trackedServers=o.trackedServers.filter((function(t){return t.serverId!==e.serverId})),o.trackedServers.length<=0)){if(clearTimeout(o.timeoutId),"awaitingAccept"===o.status){var i="string"==typeof t.reason&&""!==t.reason?' Publisher said "'+t.reason+'".':" No reason given.",s="object"==typeof o.params.arguments?JSON.stringify(o.params.arguments):"{}";o.error({message:"Subscription rejected."+i+" Called with:"+s,called_with:o.params.arguments,method:o.method})}else"subscribed"===o.status&&r.callOnClosedHandlers(o);delete r.subscriptionsList[n]}},this.handleSubscribed=function(t){var e=t._tag.subLocalKey,n=r.subscriptionsList[e];if("object"==typeof n){var o=t._tag.serverId,i=n.trackedServers.filter((function(t){return t.serverId===o}))[0];if("object"==typeof i){i.subscriptionId=t.subscription_id,r.subscriptionIdToLocalKeyMap[t.subscription_id]=e;var s="awaitingAccept"===n.status;if(n.status="subscribed",s){var a=!1,c=n.subscription;c?(c.setNewSubscription(n),n.success(c),a=!0):(c=new On(r.repository,n),n.subscription=c,n.success(c));for(var u=0,d=n.handlers.onConnected;u<d.length;u++){var p=d[u];try{p(c.serverInstance,a)}catch(t){}}}}}},this.handleEventData=function(t){var e=r.subscriptionIdToLocalKeyMap[t.subscription_id];if(void 0!==e){var n=r.subscriptionsList[e];if("object"==typeof n){var o=n.trackedServers.filter((function(e){return e.subscriptionId===t.subscription_id}));if(1===o.length){var i=t.oob,s=o[0].serverId,a=function(){return{data:t.data,server:r.repository.getServerById(s).instance,requestArguments:n.params.arguments,message:void 0,private:i}},c=n.handlers.onData,u=n.queued.data;c.length>0?c.forEach((function(t){"function"==typeof t&&t(a())})):u.push(a())}}}},this.handleSubscriptionCancelled=function(t){var e=r.subscriptionIdToLocalKeyMap[t.subscription_id];if(void 0!==e){var n=r.subscriptionsList[e];if("object"==typeof n){var o=n.trackedServers.length-1;n.trackedServers=n.trackedServers.filter((function(e){return e.subscriptionId!==t.subscription_id||(n.queued.closers.push(e.serverId),!1)})),n.trackedServers.length===o&&(n.trackedServers.length<=0&&(clearTimeout(n.timeoutId),r.callOnClosedHandlers(n),delete r.subscriptionsList[e]),delete r.subscriptionIdToLocalKeyMap[t.subscription_id])}}},t.on("subscribed",this.handleSubscribed),t.on("event",this.handleEventData),t.on("subscription-cancelled",this.handleSubscriptionCancelled)}return t.prototype.subscribe=function(t,e,n,r,o,i){var s=this;if(0!==n.length){var a=this.getNextSubscriptionLocalKey(),c=this.registerSubscription(a,t,e,r,o,e.methodResponseTimeout||1e4,i);"object"==typeof c?n.forEach((function(n){var r=n.server.id,o=n.methods.find((function(e){return e.name===t.name}));if(o){c.trackedServers.push({serverId:r,subscriptionId:void 0});var i={type:"subscribe",server_id:r,method_id:o.gatewayId,arguments_kv:e.arguments};s.session.send(i,{serverId:r,subLocalKey:a}).then((function(t){return s.handleSubscribed(t)})).catch((function(t){return s.handleErrorSubscribing(t)}))}else s.logger.error("can not find method "+t.name+" for target "+n.server.id)})):o({method:t,called_with:e.arguments,message:"Subscription failed. Unable to register the user callbacks."})}else o({method:t,called_with:e.arguments,message:"Subscription failed. No available servers matched the target params."})},t.prototype.drainSubscriptions=function(){var t=Object.values(this.subscriptionsList);return this.subscriptionsList={},this.subscriptionIdToLocalKeyMap={},t},t.prototype.getNextSubscriptionLocalKey=function(){var t=this.nextSubLocalKey;return this.nextSubLocalKey+=1,t},t.prototype.registerSubscription=function(t,e,n,r,o,i,s){var a=this,c={localKey:t,status:"awaitingAccept",method:e,params:n,success:r,error:o,trackedServers:[],handlers:{onData:(null==s?void 0:s.handlers.onData)||[],onClosed:(null==s?void 0:s.handlers.onClosed)||[],onConnected:(null==s?void 0:s.handlers.onConnected)||[]},queued:{data:[],closers:[]},timeoutId:void 0,close:function(){return a.closeSubscription(t)},subscription:null==s?void 0:s.subscription};return s||(n.onData&&c.handlers.onData.push(n.onData),n.onClosed&&c.handlers.onClosed.push(n.onClosed),n.onConnected&&c.handlers.onConnected.push(n.onConnected)),this.subscriptionsList[t]=c,c.timeoutId=setTimeout((function(){if(void 0!==a.subscriptionsList[t]){var r=a.subscriptionsList[t];"awaitingAccept"===r.status?(o({method:e,called_with:n.arguments,message:"Subscription failed. Subscription attempt timed out after "+i+" ms."}),delete a.subscriptionsList[t]):"subscribed"===r.status&&r.trackedServers.length>0&&(r.trackedServers=r.trackedServers.filter((function(t){return void 0!==t.subscriptionId})),delete r.timeoutId,r.trackedServers.length<=0&&(a.callOnClosedHandlers(r),delete a.subscriptionsList[t]))}}),i),c},t.prototype.callOnClosedHandlers=function(t,e){var n,r=t.queued.closers.length,o=r>0?t.queued.closers[r-1]:null;void 0!==o&&"string"==typeof o&&(n=this.repository.getServerById(o).instance),t.handlers.onClosed.forEach((function(r){"function"==typeof r&&r({message:e||"ServerInitiated",requestArguments:t.params.arguments||{},server:n,stream:t.method})}))},t.prototype.closeSubscription=function(t){var e=this,n=this.subscriptionsList[t];"object"==typeof n&&(n.trackedServers.forEach((function(t){void 0!==t.subscriptionId&&(n.queued.closers.push(t.serverId),e.session.sendFireAndForget({type:"unsubscribe",subscription_id:t.subscriptionId,reason_uri:"",reason:"ClientInitiated"}),delete e.subscriptionIdToLocalKeyMap[t.subscriptionId])})),n.trackedServers=[],this.callOnClosedHandlers(n,"ClientInitiated"),delete this.subscriptionsList[t])},t}(),Pn=function(){function t(t,e,n){var r=this;this.session=t,this.repository=e,this.logger=n,t.on("peer-added",(function(t){return r.handlePeerAdded(t)})),t.on("peer-removed",(function(t){return r.handlePeerRemoved(t)})),t.on("methods-added",(function(t){return r.handleMethodsAddedMessage(t)})),t.on("methods-removed",(function(t){return r.handleMethodsRemovedMessage(t)})),this.streaming=new En(t,e,n)}return t.prototype.subscribe=function(t,e,n,r,o,i){this.streaming.subscribe(t,e,n,r,o,i)},t.prototype.invoke=function(t,e,n,r){var o=this,i=r.id,s={type:"call",server_id:i,method_id:e.gatewayId,arguments_kv:n};return this.session.send(s,{invocationId:t,serverId:i}).then((function(t){return o.handleResultMessage(t)})).catch((function(t){return o.handleInvocationError(t)}))},t.prototype.drainSubscriptions=function(){return this.streaming.drainSubscriptions()},t.prototype.handlePeerAdded=function(t){var e=t.new_peer_id,n=t.identity,r=!t.meta||t.meta.local,o=Number(n.process),i={machine:n.machine,pid:isNaN(o)?n.process:o,instance:n.instance,application:n.application,applicationName:n.applicationName,environment:n.environment,region:n.region,user:n.user,windowId:n.windowId,peerId:e,api:n.api,isLocal:r};this.repository.addServer(i,e)},t.prototype.handlePeerRemoved=function(t){var e=t.removed_id,n=t.reason;this.repository.removeServerById(e,n)},t.prototype.handleMethodsAddedMessage=function(t){var e=this,n=t.server_id;t.methods.forEach((function(t){e.repository.addServerMethod(n,t)}))},t.prototype.handleMethodsRemovedMessage=function(t){var e=this,n=t.server_id,r=t.methods,o=this.repository.getServerById(n);Object.keys(o.methods).forEach((function(t){var i=o.methods[t];r.indexOf(i.gatewayId)>-1&&e.repository.removeServerMethod(n,t)}))},t.prototype.handleResultMessage=function(t){var e=t._tag.invocationId,n=t.result,r=t._tag.serverId;return{invocationId:e,result:n,instance:this.repository.getServerById(r).instance,status:pn.Success,message:""}},t.prototype.handleInvocationError=function(t){if(this.logger.debug("handle invocation error "+JSON.stringify(t)),"_tag"in t){var e=t._tag.invocationId,n=t._tag.serverId,r=this.repository.getServerById(n),o=t.reason;return{invocationId:e,result:t.context,instance:r.instance,status:pn.Error,message:o}}return{invocationId:"",message:t.message,status:pn.Error,error:t}},t}();function An(t,e,n,r,o,i){var s,a=o.logger.subLogger("gw3-protocol"),c=new Promise((function(t){s=t})),u=e.domain("agm",["subscribed"]),d=new Cn(u,n,r,a.subLogger("server")),p=new Pn(u,n,a.subLogger("client"));return u.onJoined((function(o){n.addServer(t,e.peerId),o?function(){a.info("reconnected - will replay registered methods and subscriptions");for(var t=0,e=p.drainSubscriptions();t<e.length;t++){var n=e[t],o=n.method,s=Object.assign({},n.params);a.info("trying to re-subscribe to method "+o.name),i.client.subscribe(o,s,void 0,void 0,n)}var c=r.getList();r.reset();for(var u=0,d=c;u<d.length;u++){var l=d[u],h=l.definition;a.info("re-publishing method "+h.name),l.stream?i.server.createStream(h,l.streamCallbacks,void 0,void 0,l.stream):l.theFunction&&l.theFunction.userCallback?i.register(h,l.theFunction.userCallback):l.theFunction&&l.theFunction.userCallbackAsync&&i.registerAsync(h,l.theFunction.userCallbackAsync)}}():s&&(s({client:p,server:d}),s=void 0)})),u.onLeft((function(){n.reset()})),u.join(),c}var Ln=function(){function t(t){var e=this;if(void 0===t)throw new Error("configuration is required");if(void 0===t.connection)throw new Error("configuration.connections is required");var n,r=t.connection;if("number"!=typeof t.methodResponseTimeout&&(t.methodResponseTimeout=3e4),"number"!=typeof t.waitTimeoutMs&&(t.waitTimeoutMs=3e4),_n.API=this,this.instance=new _n(void 0,r).unwrap(),this.clientRepository=new jn(t.logger.subLogger("cRep")),this.serverRepository=new Tn,3!==r.protocolVersion)throw new Error("protocol "+r.protocolVersion+" not supported");n=An(this.instance,r,this.clientRepository,this.serverRepository,t,this),this.readyPromise=n.then((function(n){return e.protocol=n,e.client=new gn(e.protocol,e.clientRepository,e.instance,t),e.server=new xn(e.protocol,e.serverRepository),e}))}return t.prototype.ready=function(){return this.readyPromise},t.prototype.serverRemoved=function(t){return this.client.serverRemoved(t)},t.prototype.serverAdded=function(t){return this.client.serverAdded(t)},t.prototype.serverMethodRemoved=function(t){return this.client.serverMethodRemoved(t)},t.prototype.serverMethodAdded=function(t){return this.client.serverMethodAdded(t)},t.prototype.methodRemoved=function(t){return this.client.methodRemoved(t)},t.prototype.methodAdded=function(t){return this.client.methodAdded(t)},t.prototype.methodsForInstance=function(t){return this.client.methodsForInstance(t)},t.prototype.methods=function(t){return this.client.methods(t)},t.prototype.servers=function(t){return this.client.servers(t)},t.prototype.subscribe=function(t,e,n,r){return this.client.subscribe(t,e,n,r)},t.prototype.createStream=function(t,e,n,r){return this.server.createStream(t,e,n,r)},t.prototype.unregister=function(t){return this.server.unregister(t)},t.prototype.registerAsync=function(t,e){return this.server.registerAsync(t,e)},t.prototype.register=function(t,e){return this.server.register(t,e)},t.prototype.invoke=function(t,e,n,r,o,i){return this.client.invoke(t,e,n,r,o,i)},t}(),Rn=["subscribed","success"],Nn=function(){function t(t,e){var n=this;this.publish=function(t,e,r){var o=r||{},i=o.routingKey,s=o.target,a=n.removeEmptyValues({type:"publish",topic:t,data:e,peer_id:n.peerId,routing_key:i,target_identity:s});n.session.send(a)},this.subscribe=function(t,e,r){return new Promise((function(o,i){var s=r||{},a=s.routingKey,c=s.target,u=n.removeEmptyValues({type:"subscribe",topic:t,peer_id:n.peerId,routing_key:a,source:c});n.session.send(u).then((function(r){var i=r.subscription_id;n.subscriptions.push({subscription_id:i,topic:t,callback:e,source:c}),o({unsubscribe:function(){return n.session.send({type:"unsubscribe",subscription_id:i,peer_id:n.peerId}),n.subscriptions=n.subscriptions.filter((function(t){return t.subscription_id!==i})),Promise.resolve()}})})).catch((function(t){return i(t)}))}))},this.watchOnEvent=function(){n.session.on("event",(function(t){var e=t.data,r=t.subscription_id,o=t["publisher-identity"],i=n.subscriptions.find((function(t){return t.subscription_id===r}));i&&(i.source?n.keysMatch(i.source,o)&&i.callback(e,i.topic,o):i.callback(e,i.topic,o))}))},this.connection=t,this.logger=e,this.peerId=t.peerId,this.subscriptions=[],this.session=t.domain("bus",Rn),this.readyPromise=this.session.join(),this.readyPromise.then((function(){n.watchOnEvent()}))}return t.prototype.ready=function(){return this.readyPromise},t.prototype.removeEmptyValues=function(t){var e={};return Object.keys(t).forEach((function(n){void 0!==t[n]&&null!==t[n]&&(e[n]=t[n])})),e},t.prototype.keysMatch=function(t,e){var n=Object.keys(t),r=!0;return n.forEach((function(n){t[n]!==e[n]&&(r=!1)})),r},t}(),Dn=function(t,e){var n,r=Ce.getGDMajorVersion(),o=Promise.resolve();if(r){if(r<3)throw new Error("GD v2 is not supported. Use v4 of the API to run in that context.");r>=3&&(n=window.glue42gd,o=window.gdPreloadPromise||o)}var i,s,a,c,u,d,p=on(),l=rn(t=t||{},e=e||{},n),h={};function f(t,e,n){a.canPublish("trace")&&a.trace("registering "+t+" module");var r=function(){e.initTime=n.stop(),e.initEndTime=n.endTime,a.trace(t+" is ready")};e.initStartTime=n.startTime,e.ready?e.ready().then((function(){r()})):r(),Array.isArray(t)||(t=[t]),t.forEach((function(t){h[t]=e,Dn[t]=e}))}function v(){var t,e,r,o=on(),s=l.metrics,u=null==n?void 0:n.getMetricsPublishingEnabled,d=l.connection.identity,p=u||function(){return!0},h=ke({connection:s?i:void 0,logger:a.subLogger("metrics"),canUpdateMetric:p,system:"Glue42",service:null!==(t=null==d?void 0:d.service)&&void 0!==t?t:"metrics-service",instance:null!==(r=null!==(e=null==d?void 0:d.instance)&&void 0!==e?e:null==d?void 0:d.windowId)&&void 0!==r?r:Ye()}),v=h;return v="boolean"!=typeof s&&s.disableAutoAppSystem?h:h.subSystem("App"),f("metrics",c=function(t){var e,n=t.subSystem("reporting"),r={name:"features"};return t.featureMetric=function(t,o,i){if(void 0===t||""===t)throw new Error("name is mandatory");if(void 0===o||""===o)throw new Error("action is mandatory");if(void 0===i||""===i)throw new Error("payload is mandatory");e?e.update({name:t,action:o,payload:i}):e=n.objectMetric(r,{name:t,action:o,payload:i})},t}(v),o),Promise.resolve()}function g(){var t=l.activities&&3===i.protocolVersion;if(l.contexts||t){var e=on();return f("contexts",u=new hn({connection:i,logger:a.subLogger("contexts")}),e),u}var n=i.replayer;n&&n.drain(nn.name)}function m(){return re(this,void 0,void 0,(function(){var t;return oe(this,(function(e){return l.bus?(t=on(),f("bus",d=new Nn(i,a.subLogger("bus")),t),[2,Promise.resolve()]):[2,Promise.resolve()]}))}))}function y(t){try{return t.forEach((function(t){!function(t,e){var n=on(),r=e(h);r&&f(t,r,n)}(t.name,t.create)})),Promise.resolve()}catch(t){return Promise.reject(t)}}return o.then((function(){var t,e=on();return(a=new en(""+(null===(t=l.connection.identity)||void 0===t?void 0:t.application),void 0,l.customLogger)).consoleLevel(l.logger.console),a.publishLevel(l.logger.publish),f("logger",a,e),Promise.resolve(void 0)})).then((function(){var t=on();i=new Ze(l.connection,a.subLogger("connection"));var e=Promise.resolve(l.auth);return l.connection&&!l.auth&&(n?(a.trace("trying to get gw token..."),e=n.getGWToken().then((function(t){return a.trace("got GW token "+(null==t?void 0:t.substring(t.length-10))),{gatewayToken:t}}))):e=Promise.reject("You need to provide auth information")),e.then((function(t){var e;if("[object Object]"!==Object.prototype.toString.call(t))throw new Error("Invalid auth object - "+JSON.stringify(t));return e=t,i.login(e)})).then((function(){return f("connection",i,t),l})).catch((function(t){throw i&&i.logout(),t}))})).then((function(){return Promise.all([v(),(t=on(),e={connection:i,logger:a.subLogger("interop")},s=new Ln(e),en.Interop=s,f(["interop","agm"],s,t),Promise.resolve()),g(),m()]);var t,e})).then((function(){return s.readyPromise})).then((function(){return y(l.libs||[])})).then((function(){var t=Object.keys(h).map((function(t){var e=h[t];return e.ready?e.ready():Promise.resolve()}));return Promise.all(t)})).then((function(){var r={coreVersion:"5.0.7",version:l.version};p.stop();var o={feedback:function(t){s&&s.invoke("T42.ACS.Feedback",t,"best")},info:r,logger:a,interop:s,agm:s,connection:i,metrics:c,contexts:u,bus:d,version:l.version,userConfig:t,done:function(){return null==a||a.info("done called by user..."),i.logout()}};return o.performance={get glueVer(){return l.version},get glueConfig(){return JSON.stringify(t)},get browser(){return window.performance.timing.toJSON()},get memory(){return window.performance.memory},get initTimes(){var t=Object.keys(o).filter((function(t){var e;return"initTimes"!==t&&"agm"!==t&&(null===(e=o[t])||void 0===e?void 0:e.initTime)})).map((function(t){return{name:t,time:o[t].initTime,startTime:o[t].initStartTime,endTime:o[t].initEndTime}}));return t.push({name:"glue",startTime:p.startTime,endTime:p.endTime,time:p.period}),t}},Object.keys(h).forEach((function(t){var e=h[t];o[t]=e})),o.config={},Object.keys(l).forEach((function(t){o.config[t]=l[t]})),e&&e.extOptions&&Object.keys(e.extOptions).forEach((function(t){o.config[t]=null==e?void 0:e.extOptions[t]})),(null==e?void 0:e.enrichGlue)&&e.enrichGlue(o),n&&n.updatePerfData&&n.updatePerfData(o.performance),o})).catch((function(t){return Promise.reject({err:t,libs:h})}))};"undefined"!=typeof window&&(window.GlueCore=Dn),Dn.version="5.0.7",Dn.default=Dn;var qn,Fn=(qn=Dn,function(t){return n(void 0,void 0,void 0,(function(){var o,i,s,a,c,u,d,p,l,h,f,v,g,m,y,b,w,S,x,_,k,I,T,M,E,P,A,L;return r(this,(function(R){switch(R.label){case 0:return[4,(U=t,n(void 0,void 0,void 0,(function(){var t,n,o,i;return r(this,(function(r){switch(r.label){case 0:return[4,Et(U=null!=U?U:{})];case 1:return t=r.sent(),(n=e(e(e({},Ot),t.glue),U)).worker=n.assets.location+"/worker.js","string"==typeof(null==n?void 0:n.extends)&&(o=n.extends.lastIndexOf("/"),i=n.extends.substr(0,o+1)+"worker.js",n.worker=i),t.layouts||(t.layouts={remoteType:"json"}),[2,e(e({},t),{glue:n})]}}))})))];case 1:if(o=R.sent(),i="undefined"!=typeof window,s=(null===(m=o.glue)||void 0===m?void 0:m.channels)||!1,a=(null===(y=o.glue)||void 0===y?void 0:y.appManager)||!1,i&&(null==(c=window)?void 0:c.glue42gd)&&(null==c?void 0:c.Glue))return[2,c.Glue({windows:!0,logger:null===(b=o.glue)||void 0===b?void 0:b.logger,channels:s,layouts:!0,appManager:a})];if(u=new j,l={libs:[{name:"notifications",create:function(t){return new Ct(t.interop)}}],version:"1.2.2"},s&&(h={name:"channels",create:function(t){return new gt(t.contexts,o.channels)}},null===(w=l.libs)||void 0===w||w.push(h)),i&&(null===(S=l.libs)||void 0===S||S.push({name:"windows",create:function(t){return d=new O(t.interop,u)}},{name:"layouts",create:function(t){var e,n,r;if("json"===(null===(e=o.layouts)||void 0===e?void 0:e.remoteType)){var i=(null===(n=null==o?void 0:o.glue.assets)||void 0===n?void 0:n.location)||"/glue";r=new $t(i)}var s=new Xt,a=new Qt,c=new At(s,a,r);return p=new Pt(c,d,u,t.interop,null==o?void 0:o.glue),new ft(p)}}),a&&(f={name:"appManager",create:function(t){var e;return new Mt(d,t.interop,u,o.appManager,null===(e=o.glue)||void 0===e?void 0:e.application)}},null===(x=l.libs)||void 0===x||x.push(f))),v={gateway:{sharedWorker:null!==(k=null===(_=o.glue)||void 0===_?void 0:_.worker)&&void 0!==k?k:"/glue/worker.js",inproc:null===(I=o.glue)||void 0===I?void 0:I.inproc},logger:null===(T=o.glue)||void 0===T?void 0:T.logger,application:null===(M=o.glue)||void 0===M?void 0:M.application},i&&!window.SharedWorker)throw new Error("Cannot initialize Glue Web, because this environment does not support Shared Workers");return[4,(F=function(){return qn(v,l)},W=1e4,B="Glue Web initialization timed out",new Promise((function(t,e){var n=setTimeout((function(){e(B||"Promise timeout hit: "+W)}),W);F().then((function(e){clearTimeout(n),t(e)})).catch((function(t){clearTimeout(n),e(t)}))})))];case 2:return g=R.sent(),(null==t?void 0:t.libraries)?[4,Promise.all(t.libraries.map((function(t){return t(g,null==o?void 0:o.glue)})))]:[3,4];case 3:R.sent(),R.label=4;case 4:return u.start(g.interop,g.logger.subLogger("control")),i?[4,(N=g.windows.my(),D=g.interop,q=null===(E=g.appManager)||void 0===E?void 0:E.myInstance,n(void 0,void 0,void 0,(function(){var t,e;return r(this,(function(n){switch(n.label){case 0:return t=C(N.id),D.methods().find((function(e){return e.name===t}))?[4,D.invoke(t)]:[3,2];case 1:e=n.sent(),N&&(N.setContext(e.returned.context),N.name=e.returned.name,N.parent=e.returned.parent,q&&(q.startedByScript=!0,q.context=e.returned.context)),n.label=2;case 2:return[2]}}))})))]:[3,9];case 5:return R.sent(),(null===(A=null===(P=o.glue)||void 0===P?void 0:P.layouts)||void 0===A?void 0:A.autoRestore)?[4,null==p?void 0:p.restoreAutoSavedLayout()]:[3,7];case 6:R.sent(),R.label=7;case 7:return[4,Zt(g,null!==(L=o.glue)&&void 0!==L?L:{},u,p)];case 8:R.sent(),R.label=9;case 9:return[2,g]}var N,D,q,F,W,B,U}))}))});if("undefined"!=typeof window){var Wn=window;Wn.GlueWeb=Fn,delete Wn.GlueCore}return Fn.default=Fn,Fn.version="1.2.2",Fn}));
//# sourceMappingURL=web.umd.min.js.map
